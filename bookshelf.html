<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è”µæ›¸æ¤œç´¢ã‚¢ãƒ—ãƒªã€Œãƒ–ãƒƒã‚¯ã‚·ã‚§ãƒ«ãƒ•ã€v2</title>
  <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root {
      --primary-color: #007BFF;
      --bg-color: #f4f7f6;
      --card-bg: #ffffff;
      --text-color: #333;
    }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .screen {
      display: none;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .screen.active {
      display: block;
    }
    h1, h2, h3 {
      text-align: center;
      margin-top: 0;
    }
    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .stats {
      font-size: 1.2em;
      text-align: center;
      margin-bottom: 10px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    .btn:hover { background: #0056b3; }
    .btn-back { background: #6c757d; width: auto; display: inline-block; padding: 8px 15px; margin-bottom: 0; }
    .btn-delete { background: #dc3545; width: auto; padding: 8px 15px; font-size: 14px; margin: 0; color: white;}
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    
    .nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }
    .nav-header h2 { margin: 0; font-size: 1.3em; }

    /* æœ¬ã®ãƒªã‚¹ãƒˆè¡¨ç¤ºç”¨ */
    .book-item-container {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
    }
    .book-item-container:last-child { border-bottom: none; }
    .book-header {
      display: flex;
      align-items: flex-start;
    }
    .book-header img {
      width: 60px;
      height: auto;
      margin-right: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .book-info {
      flex-grow: 1;
    }
    .book-info strong { display: block; font-size: 1.1em; margin-bottom: 5px; }
    .book-info small { color: #666; display: block; line-height: 1.4; }
    .empty-msg { text-align: center; color: #888; }

    /* è”µæ›¸è©³ç´°ãƒ»æ„Ÿæƒ³å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .book-details {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 0.9em;
      border: 1px solid #e9ecef;
    }
    .book-details label {
      font-weight: bold;
      color: #555;
      display: block;
      margin-bottom: 4px;
    }
    .book-details select, .book-details textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      box-sizing: border-box;
    }
    .detail-row {
      display: flex;
      gap: 15px;
    }
    .detail-row > div {
      flex: 1;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- 4. ãƒˆãƒƒãƒ—ç”»é¢ -->
  <div id="screen-top" class="screen active">
    <h1>ğŸ“š ãƒ–ãƒƒã‚¯ã‚·ã‚§ãƒ«ãƒ•</h1>
    <div class="card stats">
      <p>è”µæ›¸æ•°: <strong id="count-collection" style="color: var(--primary-color);">0</strong> å†Š</p>
      <p>ã»ã—ã„æœ¬: <strong id="count-wish" style="color: #ff9800;">0</strong> å†Š</p>
    </div>
    <button class="btn" onclick="showScreen('screen-scan')">ğŸ“· 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button class="btn" onclick="showScreen('screen-wish')" style="background-color: #ff9800;">â­ 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
    <button class="btn" onclick="showScreen('screen-collection')" style="background-color: #28a745;">ğŸ“– 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</button>
  </div>

  <!-- 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ -->
  <div id="screen-scan" class="screen">
    <div class="nav-header">
      <h2>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    <div class="card">
      <p style="font-size: 0.9em; color:#555;">æœ¬ã®è£ã«ã‚ã‚‹ä¸Šæ®µã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆ978ã¾ãŸã¯979ã‹ã‚‰å§‹ã¾ã‚‹ISBNï¼‰ã‚’å†™ã—ã¦ãã ã•ã„ã€‚</p>
      <div id="reader" style="width:100%;"></div>
    </div>
    <div id="scan-result" class="card" style="display:none;"></div>
  </div>

  <!-- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆç”»é¢ -->
  <div id="screen-wish" class="screen">
    <div class="nav-header">
      <h2>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    
    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ -->
    <div class="card">
      <h3>ğŸ” æœ¬ã‚’æ¤œç´¢ã—ã¦è¿½åŠ </h3>
      <input type="text" id="wish-search-input" placeholder="æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…åã‚’å…¥åŠ›">
      <button class="btn" onclick="searchWishBook()">æ¤œç´¢</button>
      <div id="wish-search-results"></div>
    </div>

    <!-- æ‰‹å‹•è¿½åŠ  -->
    <div class="card">
      <h3>âœï¸ æ‰‹å‹•ã§è¿½åŠ </h3>
      <input type="text" id="manual-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (å¿…é ˆ)">
      <input type="text" id="manual-author" placeholder="è‘—è€…å">
      <input type="text" id="manual-publisher" placeholder="å‡ºç‰ˆç¤¾">
      <button class="btn" onclick="addManualWish()" style="background-color: #6c757d;">æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹</button>
    </div>

    <!-- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¸€è¦§ -->
    <div class="card">
      <h3>â­ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¸€è¦§</h3>
      <div id="wish-list-container"></div>
    </div>
  </div>

  <!-- 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢ç”»é¢ -->
  <div id="screen-collection" class="screen">
    <div class="nav-header">
      <h2>è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    <div class="card">
      <input type="text" id="collection-search-input" placeholder="ğŸ” è”µæ›¸ã®ä¸­ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…åã§æ¤œç´¢" oninput="renderCollection()">
    </div>
    <div class="card" id="collection-list-container"></div>
  </div>

  <script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã°ç©ºã®é…åˆ—ï¼‰
    let collection = JSON.parse(localStorage.getItem('bookshelf_collection')) ||[];
    let wishlist = JSON.parse(localStorage.getItem('bookshelf_wishlist')) ||[];

    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãƒˆãƒƒãƒ—ç”»é¢ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
    function saveData() {
      localStorage.setItem('bookshelf_collection', JSON.stringify(collection));
      localStorage.setItem('bookshelf_wishlist', JSON.stringify(wishlist));
      updateCounts();
    }

    // --- ç”»é¢é·ç§»ç®¡ç† ---
    let html5QrcodeScanner = null;

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      
      if (screenId !== 'screen-scan') {
        stopScanner();
      }

      document.getElementById(screenId).classList.add('active');

      if (screenId === 'screen-top') {
        updateCounts();
      } else if (screenId === 'screen-scan') {
        startScanner();
      } else if (screenId === 'screen-wish') {
        renderWishlist();
      } else if (screenId === 'screen-collection') {
        document.getElementById('collection-search-input').value = ""; 
        renderCollection();
      }
    }

    // --- 4. ãƒˆãƒƒãƒ—ç”»é¢ ---
    function updateCounts() {
      document.getElementById('count-collection').innerText = collection.length;
      document.getElementById('count-wish').innerText = wishlist.length;
    }

    // --- 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ ---
    function startScanner() {
      if (html5QrcodeScanner) return;
      html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: { width: 250, height: 150 } }, false
      );
      html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().then(() => {
          html5QrcodeScanner = null;
        }).catch(err => console.error(err));
      }
      document.getElementById('scan-result').style.display = 'none';
    }

    function onScanSuccess(decodedText) {
      if (decodedText.startsWith("978") || decodedText.startsWith("979")) {
        stopScanner();
        fetchBookByISBN(decodedText);
      }
    }

    function onScanFailure(error) { /* ç„¡è¦– */ }

    // ã€æ”¹å–„ã€‘OpenBD API ã¨ Google Books API ã®äºŒæ®µæ§‹ãˆã§æƒ…å ±ã‚’å–å¾—
    async function fetchBookByISBN(isbn) {
      const resultDiv = document.getElementById('scan-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = "<p>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰æœ¬ã®æƒ…å ±ã‚’å–å¾—ä¸­...</p>";
      
      let bookData = null;

      // â‘  ã¾ãšæ—¥æœ¬ã®æœ¬ã«å¼·ã„ OpenBD API ã‚’è©¦ã™
      try {
        const obdRes = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
        const obdData = await obdRes.json();
        if (obdData && obdData[0]) {
          const summary = obdData[0].summary;
          bookData = {
            isbn: isbn,
            title: summary.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜",
            author: summary.author || "è‘—è€…ä¸æ˜",
            publisher: summary.publisher || "å‡ºç‰ˆç¤¾ä¸æ˜",
            thumbnail: summary.cover || ""
          };
        }
      } catch (e) {
        console.warn("OpenBDå–å¾—ã‚¨ãƒ©ãƒ¼:", e);
      }

      // â‘¡ OpenBDã§è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° Google Books API ã‚’è©¦ã™
      if (!bookData) {
        try {
          const gbRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
          const gbData = await gbRes.json();
          if (gbData.items && gbData.items.length > 0) {
            const info = gbData.items[0].volumeInfo;
            bookData = {
              isbn: isbn,
              title: info.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜",
              author: info.authors ? info.authors.join(", ") : "è‘—è€…ä¸æ˜",
              publisher: info.publisher || "å‡ºç‰ˆç¤¾ä¸æ˜",
              thumbnail: info.imageLinks ? info.imageLinks.thumbnail : ""
            };
          }
        } catch (e) {
          console.warn("Google Bookså–å¾—ã‚¨ãƒ©ãƒ¼:", e);
        }
      }

      // çµæœã®è¡¨ç¤º
      if (bookData) {
        const titleSafe = escapeHtml(bookData.title);
        const authorSafe = escapeHtml(bookData.author);
        const pubSafe = escapeHtml(bookData.publisher);
        const thumbSafe = bookData.thumbnail;

        resultDiv.innerHTML = `
          <h3>å–å¾—çµæœ</h3>
          <div class="book-item-container">
            <div class="book-header">
              ${thumbSafe ? `<img src="${thumbSafe}">` : `<div style="width:60px;height:80px;background:#ccc;margin-right:15px;"></div>`}
              <div class="book-info">
                <strong>${titleSafe}</strong>
                <small>è‘—è€…: ${authorSafe}</small>
                <small>å‡ºç‰ˆç¤¾: ${pubSafe}</small>
              </div>
            </div>
          </div>
          <button class="btn" style="background-color: #28a745;" onclick="addToCollection('${isbn}', '${titleSafe}', '${authorSafe}', '${pubSafe}', '${thumbSafe}')">ã“ã®æœ¬ã‚’è”µæ›¸ã«ç™»éŒ²ã™ã‚‹</button>
          <button class="btn btn-back" onclick="resetScanner()">ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹</button>
        `;
      } else {
        resultDiv.innerHTML = `
          <p style="color:red;">æœ¬ã®æƒ…å ±ï¼ˆISBN: ${isbn}ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
          <button class="btn btn-back" onclick="resetScanner()">å†ã‚¹ã‚­ãƒ£ãƒ³</button>
        `;
      }
    }

    function resetScanner() {
      document.getElementById('scan-result').style.display = 'none';
      startScanner();
    }

    function addToCollection(isbn, title, author, publisher, thumbnail) {
      collection.push({ 
        id: Date.now(), 
        isbn, 
        title, 
        author, 
        publisher, 
        thumbnail,
        status: 'unread', // åˆæœŸçŠ¶æ…‹ã¯æœªèª­
        review: '',
        rating: 0
      });
      saveData();
      alert("è”µæ›¸ã«ç™»éŒ²ã—ã¾ã—ãŸï¼");
      showScreen('screen-top');
    }

    // --- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆæ©Ÿèƒ½ ---
    // ã€æ”¹å–„ã€‘ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†ã‹ã‚Šã‚„ã™ã
    async function searchWishBook() {
      const query = document.getElementById('wish-search-input').value;
      if (!query) return;
      const resultsDiv = document.getElementById('wish-search-results');
      resultsDiv.innerHTML = "<p>æ¤œç´¢ä¸­...</p>";
      
      try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
        if (!response.ok) throw new Error("APIé€šä¿¡ã‚¨ãƒ©ãƒ¼");
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
          resultsDiv.innerHTML = "";
          data.items.forEach(item => {
            const info = item.volumeInfo;
            const title = info.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
            const author = info.authors ? info.authors.join(", ") : "è‘—è€…ä¸æ˜";
            const publisher = info.publisher || "å‡ºç‰ˆç¤¾ä¸æ˜";
            const thumbnail = info.imageLinks ? info.imageLinks.thumbnail : "";
            const isbnObj = info.industryIdentifiers ? info.industryIdentifiers.find(i => i.type === "ISBN_13") : null;
            const isbn = isbnObj ? isbnObj.identifier : "";

            const div = document.createElement('div');
            div.className = "book-item-container";
            div.innerHTML = `
              <div class="book-header">
                ${thumbnail ? `<img src="${thumbnail}">` : `<div style="width:60px;height:80px;background:#ccc;margin-right:15px;"></div>`}
                <div class="book-info">
                  <strong>${escapeHtml(title)}</strong>
                  <small>è‘—è€…: ${escapeHtml(author)}</small>
                  <small>å‡ºç‰ˆç¤¾: ${escapeHtml(publisher)}</small>
                </div>
              </div>
              <button class="btn" style="background-color: #ff9800; margin-top:10px; padding:8px;" onclick="addToWishlist('${escapeHtml(title)}', '${escapeHtml(author)}', '${escapeHtml(publisher)}', '${thumbnail}', '${isbn}')">ã“ã®æœ¬ã‚’ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            `;
            resultsDiv.appendChild(div);
          });
        } else {
          resultsDiv.innerHTML = "<p>è©²å½“ã™ã‚‹æœ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã™ã‚‹ã‹ã€æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>";
        }
      } catch(e) {
        resultsDiv.innerHTML = "<p style='color:red;'>é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>";
      }
    }

    // æ‰‹å‹•è¿½åŠ ï¼ˆå‡ºç‰ˆç¤¾å¯¾å¿œï¼‰
    function addManualWish() {
      const title = document.getElementById('manual-title').value;
      const author = document.getElementById('manual-author').value || "è‘—è€…ä¸æ˜";
      const publisher = document.getElementById('manual-publisher').value || "å‡ºç‰ˆç¤¾ä¸æ˜";
      if (!title) { alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      
      addToWishlist(title, author, publisher, "", "");
      document.getElementById('manual-title').value = "";
      document.getElementById('manual-author').value = "";
      document.getElementById('manual-publisher').value = "";
    }

    function addToWishlist(title, author, publisher, thumbnail, isbn) {
      wishlist.push({ id: Date.now(), title, author, publisher, thumbnail, isbn });
      saveData();
      alert("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼");
      renderWishlist();
      document.getElementById('wish-search-results').innerHTML = "";
      document.getElementById('wish-search-input').value = "";
    }

    // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆè¡¨ç¤ºã¨è”µæ›¸ã¸ã®ç§»å‹•
    function renderWishlist() {
      const container = document.getElementById('wish-list-container');
      container.innerHTML = "";
      
      if(wishlist.length === 0) {
        container.innerHTML = "<p class='empty-msg'>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ã€‚</p>";
        return;
      }
      
      wishlist.forEach((book, index) => {
        const div = document.createElement('div');
        div.className = "book-item-container";
        div.innerHTML = `
          <div class="book-header">
            ${book.thumbnail ? `<img src="${book.thumbnail}">` : `<div style="width:60px;height:80px;background:#eee;margin-right:15px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa;">ç”»åƒãªã—</div>`}
            <div class="book-info">
              <strong>${book.title}</strong>
              <small>è‘—è€…: ${book.author}</small>
              <small>å‡ºç‰ˆç¤¾: ${book.publisher || 'ä¸æ˜'}</small>
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn" style="background-color: #28a745; margin:0; flex:1;" onclick="moveToCollection(${index})">ğŸ“– è”µæ›¸ã¸ç§»å‹•</button>
            <button class="btn btn-delete" style="flex:0 0 auto;" onclick="removeWish(${index})">å‰Šé™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // ã€è¿½åŠ ã€‘ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰è”µæ›¸ã¸ç§»å‹•
    function moveToCollection(index) {
      const book = wishlist[index];
      // è”µæ›¸ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä»˜ä¸ã—ã¦è¿½åŠ 
      collection.push({
        ...book,
        id: Date.now(), // IDã‚’æ–°è¦ç™ºè¡Œ
        status: 'unread',
        review: '',
        rating: 0
      });
      // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰ã¯å‰Šé™¤
      wishlist.splice(index, 1);
      saveData();
      renderWishlist();
      alert("è”µæ›¸ãƒªã‚¹ãƒˆã¸ç§»å‹•ã—ã¾ã—ãŸï¼");
    }

    function removeWish(index) {
      if (confirm("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        wishlist.splice(index, 1);
        saveData();
        renderWishlist();
      }
    }

    // --- 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢æ©Ÿèƒ½ ---
    // ã€æ”¹å–„ã€‘çŠ¶æ…‹ã€è©•ä¾¡ã€æ„Ÿæƒ³ã®è¡¨ç¤ºã¨ç·¨é›†æ©Ÿèƒ½ã‚’è¿½åŠ 
    function renderCollection() {
      const query = document.getElementById('collection-search-input').value.toLowerCase();
      const container = document.getElementById('collection-list-container');
      container.innerHTML = "";
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const filtered = collection.filter(book => 
        book.title.toLowerCase().includes(query) || 
        book.author.toLowerCase().includes(query) ||
        (book.publisher && book.publisher.toLowerCase().includes(query))
      );

      if(filtered.length === 0) {
        container.innerHTML = "<p class='empty-msg'>è©²å½“ã™ã‚‹è”µæ›¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      filtered.forEach((book) => {
        const div = document.createElement('div');
        div.className = "book-item-container";
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®è¡¨ç¤ºã§ã‚‚ã€ä¿å­˜æ™‚ã®ç‰¹å®šã®ãŸã‚å…ƒã®é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        const originalIndex = collection.indexOf(book);
        
        div.innerHTML = `
          <div class="book-header">
            ${book.thumbnail ? `<img src="${book.thumbnail}">` : `<div style="width:60px;height:80px;background:#eee;margin-right:15px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa;">ç”»åƒãªã—</div>`}
            <div class="book-info">
              <strong>${book.title}</strong>
              <small>è‘—è€…: ${book.author}</small>
              <small>å‡ºç‰ˆç¤¾: ${book.publisher || 'ä¸æ˜'}</small>
            </div>
          </div>
          
          <!-- æ„Ÿæƒ³ã‚„è©•ä¾¡ã®ç·¨é›†ã‚¨ãƒªã‚¢ -->
          <div class="book-details">
            <div class="detail-row">
              <div>
                <label>çŠ¶æ…‹</label>
                <select onchange="updateCollectionData(${originalIndex}, 'status', this.value)">
                  <option value="unread" ${book.status !== 'read' ? 'selected' : ''}>æœªèª­</option>
                  <option value="read" ${book.status === 'read' ? 'selected' : ''}>æ—¢èª­</option>
                </select>
              </div>
              <div>
                <label>è©•ä¾¡</label>
                <select onchange="updateCollectionData(${originalIndex}, 'rating', this.value)">
                  <option value="0" ${book.rating == 0 ? 'selected' : ''}>æœªè©•ä¾¡</option>
                  <option value="1" ${book.rating == 1 ? 'selected' : ''}>â˜…1</option>
                  <option value="2" ${book.rating == 2 ? 'selected' : ''}>â˜…2</option>
                  <option value="3" ${book.rating == 3 ? 'selected' : ''}>â˜…3</option>
                  <option value="4" ${book.rating == 4 ? 'selected' : ''}>â˜…4</option>
                  <option value="5" ${book.rating == 5 ? 'selected' : ''}>â˜…5 (æœ€é«˜)</option>
                </select>
              </div>
            </div>
            <label>èª­ã‚“ã æ„Ÿæƒ³</label>
            <textarea rows="2" placeholder="æ„Ÿæƒ³ã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." onchange="updateCollectionData(${originalIndex}, 'review', this.value)">${book.review || ''}</textarea>
            
            <div style="text-align: right;">
              <button class="btn btn-delete" onclick="removeCollection(${originalIndex})">è”µæ›¸ã‹ã‚‰å‰Šé™¤</button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // è©•ä¾¡ã‚„æ„Ÿæƒ³ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰å³åº§ã«ä¿å­˜ã™ã‚‹å‡¦ç†
    function updateCollectionData(index, field, value) {
      collection[index][field] = value;
      saveData();
    }

    function removeCollection(index) {
      if (confirm("è”µæ›¸ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        collection.splice(index, 1);
        saveData();
        renderCollection();
      }
    }

    // --- è£œåŠ©é–¢æ•° (ã‚µãƒ‹ã‚¿ã‚¤ã‚º) ---
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // --- åˆæœŸåŒ– ---
    window.onload = () => {
      updateCounts();
    };
  </script>
</body>
</html>
