<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è”µæ›¸æ¤œç´¢ã‚¢ãƒ—ãƒªã€Œãƒ–ãƒƒã‚¯ã‚·ã‚§ãƒ«ãƒ•ã€</title>
  <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root {
      --primary-color: #007BFF;
      --bg-color: #f4f7f6;
      --card-bg: #ffffff;
      --text-color: #333;
    }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .screen {
      display: none;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .screen.active {
      display: block;
    }
    h1, h2, h3 {
      text-align: center;
      margin-top: 0;
    }
    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .stats {
      font-size: 1.2em;
      text-align: center;
      margin-bottom: 10px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    .btn:hover { background: #0056b3; }
    .btn-back { background: #6c757d; width: auto; display: inline-block; padding: 8px 15px; }
    .btn-delete { background: #dc3545; width: auto; padding: 6px 12px; font-size: 14px; margin: 0; }
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    
    .nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }
    .nav-header h2 { margin: 0; font-size: 1.5em; }

    /* æœ¬ã®ãƒªã‚¹ãƒˆè¡¨ç¤ºç”¨ */
    .book-item {
      display: flex;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 15px 0;
    }
    .book-item:last-child { border-bottom: none; }
    .book-item img {
      width: 60px;
      height: auto;
      margin-right: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .book-info {
      flex-grow: 1;
    }
    .book-info strong { display: block; font-size: 1.1em; margin-bottom: 5px; }
    .book-info small { color: #666; }
    .empty-msg { text-align: center; color: #888; }
  </style>
</head>
<body>

  <!-- 4. ãƒˆãƒƒãƒ—ç”»é¢ -->
  <div id="screen-top" class="screen active">
    <h1>ğŸ“š ãƒ–ãƒƒã‚¯ã‚·ã‚§ãƒ«ãƒ•</h1>
    <div class="card stats">
      <p>è”µæ›¸æ•°: <strong id="count-collection" style="color: var(--primary-color);">0</strong> å†Š</p>
      <p>ã»ã—ã„æœ¬: <strong id="count-wish" style="color: #ff9800;">0</strong> å†Š</p>
    </div>
    <button class="btn" onclick="showScreen('screen-scan')">ğŸ“· 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button class="btn" onclick="showScreen('screen-wish')" style="background-color: #ff9800;">â­ 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
    <button class="btn" onclick="showScreen('screen-collection')" style="background-color: #28a745;">ğŸ“– 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢ãã†ã„ã¡</button>
  </div>

  <!-- 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ -->
  <div id="screen-scan" class="screen">
    <div class="nav-header">
      <h2>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    <div class="card">
      <p style="font-size: 0.9em; color:#555;">æœ¬ã®è£ã«ã‚ã‚‹ä¸Šæ®µã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆ978ã¾ãŸã¯979ã‹ã‚‰å§‹ã¾ã‚‹ISBNï¼‰ã‚’å†™ã—ã¦ãã ã•ã„ã€‚</p>
      <div id="reader" style="width:100%;"></div>
    </div>
    <div id="scan-result" class="card" style="display:none;"></div>
  </div>

  <!-- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆç”»é¢ -->
  <div id="screen-wish" class="screen">
    <div class="nav-header">
      <h2>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    
    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ -->
    <div class="card">
      <h3>ğŸ” æœ¬ã‚’æ¤œç´¢ã—ã¦è¿½åŠ </h3>
      <input type="text" id="wish-search-input" placeholder="æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…åã‚’å…¥åŠ›">
      <button class="btn" onclick="searchWishBook()">æ¤œç´¢</button>
      <div id="wish-search-results"></div>
    </div>

    <!-- æ‰‹å‹•è¿½åŠ  -->
    <div class="card">
      <h3>âœï¸ æ‰‹å‹•ã§è¿½åŠ </h3>
      <input type="text" id="manual-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (å¿…é ˆ)">
      <input type="text" id="manual-author" placeholder="è‘—è€…å">
      <button class="btn" onclick="addManualWish()" style="background-color: #6c757d;">æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹</button>
    </div>

    <!-- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¸€è¦§ -->
    <div class="card">
      <h3>â­ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¸€è¦§</h3>
      <div id="wish-list-container"></div>
    </div>
  </div>

  <!-- 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢ç”»é¢ -->
  <div id="screen-collection" class="screen">
    <div class="nav-header">
      <h2>è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    <div class="card">
      <input type="text" id="collection-search-input" placeholder="ğŸ” è”µæ›¸ã®ä¸­ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…åã§æ¤œç´¢" oninput="renderCollection()">
    </div>
    <div class="card" id="collection-list-container"></div>
  </div>

  <script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãªã‘ã‚Œã°ç©ºã®é…åˆ—ï¼‰
    let collection = JSON.parse(localStorage.getItem('bookshelf_collection')) ||[];
    let wishlist = JSON.parse(localStorage.getItem('bookshelf_wishlist')) ||[];

    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãƒˆãƒƒãƒ—ç”»é¢ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
    function saveData() {
      localStorage.setItem('bookshelf_collection', JSON.stringify(collection));
      localStorage.setItem('bookshelf_wishlist', JSON.stringify(wishlist));
      updateCounts();
    }

    // --- ç”»é¢é·ç§»ç®¡ç† ---
    let html5QrcodeScanner = null;

    function showScreen(screenId) {
      // å…¨ç”»é¢ã‚’éè¡¨ç¤º
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      
      // ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ä»¥å¤–ã«ç§»å‹•ã—ãŸå ´åˆã¯ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
      if (screenId !== 'screen-scan') {
        stopScanner();
      }

      // æŒ‡å®šã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤º
      document.getElementById(screenId).classList.add('active');

      // ç”»é¢ã”ã¨ã®åˆæœŸåŒ–å‡¦ç†
      if (screenId === 'screen-top') {
        updateCounts();
      } else if (screenId === 'screen-scan') {
        startScanner();
      } else if (screenId === 'screen-wish') {
        renderWishlist();
      } else if (screenId === 'screen-collection') {
        document.getElementById('collection-search-input').value = ""; // æ¤œç´¢çª“ãƒªã‚»ãƒƒãƒˆ
        renderCollection();
      }
    }

    // --- 4. ãƒˆãƒƒãƒ—ç”»é¢ ---
    function updateCounts() {
      document.getElementById('count-collection').innerText = collection.length;
      document.getElementById('count-wish').innerText = wishlist.length;
    }

    // --- 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ ---
    function startScanner() {
      if (html5QrcodeScanner) return; // ã™ã§ã«èµ·å‹•ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
      
      // ã‚«ãƒ¡ãƒ©ã®è¨­å®š
      html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: { width: 250, height: 150 } }, false
      );
      html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().then(() => {
          html5QrcodeScanner = null;
        }).catch(err => console.error(err));
      }
      document.getElementById('scan-result').style.display = 'none';
    }

    function onScanSuccess(decodedText) {
      // æ—¥æœ¬ã®æ›¸ç±ï¼ˆISBNï¼‰ã¯é€šå¸¸978ã‹979ã‹ã‚‰å§‹ã¾ã‚‹
      if (decodedText.startsWith("978") || decodedText.startsWith("979")) {
        stopScanner(); // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸã—ãŸã‚‰ã‚«ãƒ¡ãƒ©ã‚’æ­¢ã‚ã‚‹
        fetchBookByISBN(decodedText);
      }
    }

    function onScanFailure(error) {
      // ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã¯å¸¸ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§ç„¡è¦–ã§OK
    }

    // Google Books APIã‹ã‚‰ISBNã§æ¤œç´¢
    async function fetchBookByISBN(isbn) {
      const resultDiv = document.getElementById('scan-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = "<p>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰æœ¬ã®æƒ…å ±ã‚’å–å¾—ä¸­...</p>";
      
      try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
          const info = data.items[0].volumeInfo;
          const title = info.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
          const author = info.authors ? info.authors.join(", ") : "è‘—è€…ä¸æ˜";
          const thumbnail = info.imageLinks ? info.imageLinks.thumbnail : "";
          
          resultDiv.innerHTML = `
            <h3>å–å¾—çµæœ</h3>
            <div class="book-item">
              ${thumbnail ? `<img src="${thumbnail}">` : `<div style="width:60px;height:80px;background:#ccc;margin-right:15px;"></div>`}
              <div class="book-info">
                <strong>${escapeHtml(title)}</strong>
                <small>${escapeHtml(author)}</small>
              </div>
            </div>
            <button class="btn" style="background-color: #28a745;" onclick="addToCollection('${isbn}', '${escapeHtml(title)}', '${escapeHtml(author)}', '${thumbnail}')">ã“ã®æœ¬ã‚’è”µæ›¸ã«ç™»éŒ²ã™ã‚‹</button>
            <button class="btn btn-back" onclick="resetScanner()">ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹</button>
          `;
        } else {
          resultDiv.innerHTML = `
            <p>æœ¬ã®æƒ…å ±ï¼ˆISBN: ${isbn}ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            <button class="btn" onclick="resetScanner()">å†ã‚¹ã‚­ãƒ£ãƒ³</button>
          `;
        }
      } catch (e) {
        resultDiv.innerHTML = `
          <p>é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
          <button class="btn" onclick="resetScanner()">å†ã‚¹ã‚­ãƒ£ãƒ³</button>
        `;
      }
    }

    function resetScanner() {
      document.getElementById('scan-result').style.display = 'none';
      startScanner();
    }

    function addToCollection(isbn, title, author, thumbnail) {
      collection.push({ id: Date.now(), isbn, title, author, thumbnail });
      saveData();
      alert("è”µæ›¸ã«ç™»éŒ²ã—ã¾ã—ãŸï¼");
      showScreen('screen-top');
    }

    // --- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆæ©Ÿèƒ½ ---
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
    async function searchWishBook() {
      const query = document.getElementById('wish-search-input').value;
      if (!query) return;
      const resultsDiv = document.getElementById('wish-search-results');
      resultsDiv.innerHTML = "<p>æ¤œç´¢ä¸­...</p>";
      
      try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=5`);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
          resultsDiv.innerHTML = "";
          data.items.forEach(item => {
            const info = item.volumeInfo;
            const title = info.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
            const author = info.authors ? info.authors.join(", ") : "è‘—è€…ä¸æ˜";
            const thumbnail = info.imageLinks ? info.imageLinks.thumbnail : "";
            
            const div = document.createElement('div');
            div.className = "book-item";
            div.innerHTML = `
              ${thumbnail ? `<img src="${thumbnail}">` : `<div style="width:60px;height:80px;background:#ccc;margin-right:15px;"></div>`}
              <div class="book-info">
                <strong>${escapeHtml(title)}</strong>
                <small>${escapeHtml(author)}</small>
              </div>
              <button class="btn btn-back" style="background-color: #ff9800; color: white;" onclick="addToWishlist('${escapeHtml(title)}', '${escapeHtml(author)}', '${thumbnail}')">è¿½åŠ </button>
            `;
            resultsDiv.appendChild(div);
          });
        } else {
          resultsDiv.innerHTML = "<p>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
        }
      } catch(e) {
        resultsDiv.innerHTML = "<p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>";
      }
    }

    // æ‰‹å‹•è¿½åŠ 
    function addManualWish() {
      const title = document.getElementById('manual-title').value;
      const author = document.getElementById('manual-author').value;
      if (!title) { alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      
      addToWishlist(title, author, "");
      document.getElementById('manual-title').value = "";
      document.getElementById('manual-author').value = "";
    }

    // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã¸ç™»éŒ²
    function addToWishlist(title, author, thumbnail) {
      wishlist.push({ id: Date.now(), title, author, thumbnail });
      saveData();
      alert("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼");
      renderWishlist();
      document.getElementById('wish-search-results').innerHTML = "";
      document.getElementById('wish-search-input').value = "";
    }

    // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderWishlist() {
      const container = document.getElementById('wish-list-container');
      container.innerHTML = "";
      
      if(wishlist.length === 0) {
        container.innerHTML = "<p class='empty-msg'>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ã€‚</p>";
        return;
      }
      
      wishlist.forEach((book, index) => {
        const div = document.createElement('div');
        div.className = "book-item";
        div.innerHTML = `
          ${book.thumbnail ? `<img src="${book.thumbnail}">` : `<div style="width:60px;height:80px;background:#eee;margin-right:15px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa;">ç”»åƒãªã—</div>`}
          <div class="book-info">
            <strong>${book.title}</strong>
            <small>${book.author}</small>
          </div>
          <button class="btn btn-delete" onclick="removeWish(${index})">å‰Šé™¤</button>
        `;
        container.appendChild(div);
      });
    }

    function removeWish(index) {
      if (confirm("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        wishlist.splice(index, 1);
        saveData();
        renderWishlist();
      }
    }

    // --- 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢æ©Ÿèƒ½ ---
    function renderCollection() {
      const query = document.getElementById('collection-search-input').value.toLowerCase();
      const container = document.getElementById('collection-list-container');
      container.innerHTML = "";
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const filtered = collection.filter(book => 
        book.title.toLowerCase().includes(query) || 
        book.author.toLowerCase().includes(query)
      );

      if(filtered.length === 0) {
        container.innerHTML = "<p class='empty-msg'>è©²å½“ã™ã‚‹è”µæ›¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      filtered.forEach((book, index) => {
        const div = document.createElement('div');
        div.className = "book-item";
        // è¡¨ç¤ºç”¨ã®å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        const originalIndex = collection.indexOf(book);
        
        div.innerHTML = `
          ${book.thumbnail ? `<img src="${book.thumbnail}">` : `<div style="width:60px;height:80px;background:#eee;margin-right:15px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa;">ç”»åƒãªã—</div>`}
          <div class="book-info">
            <strong>${book.title}</strong>
            <small>${book.author}</small>
            ${book.isbn ? `<br><small style="font-size: 0.8em; color: #999;">ISBN: ${book.isbn}</small>` : ''}
          </div>
          <button class="btn btn-delete" onclick="removeCollection(${originalIndex})">å‰Šé™¤</button>
        `;
        container.appendChild(div);
      });
    }

    function removeCollection(index) {
      if (confirm("è”µæ›¸ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        collection.splice(index, 1);
        saveData();
        renderCollection();
      }
    }

    // --- è£œåŠ©é–¢æ•° (ã‚µãƒ‹ã‚¿ã‚¤ã‚º) ---
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // --- åˆæœŸåŒ– ---
    window.onload = () => {
      updateCounts();
    };
  </script>
</body>
</html>
