<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è”µæ›¸æ¤œç´¢ã‚¢ãƒ—ãƒªã€Œãƒ–ãƒƒã‚¯ã‚·ã‚§ãƒ«ãƒ•ã€v3</title>
  <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root {
      --primary-color: #007BFF;
      --bg-color: #f4f7f6;
      --card-bg: #ffffff;
      --text-color: #333;
    }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .screen {
      display: none;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .screen.active {
      display: block;
    }
    h1, h2, h3 {
      text-align: center;
      margin-top: 0;
    }
    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .stats {
      font-size: 1.2em;
      text-align: center;
      margin-bottom: 10px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    .btn:hover { background: #0056b3; }
    .btn-back { background: #6c757d; width: auto; display: inline-block; padding: 8px 15px; margin-bottom: 0; }
    .btn-delete { background: #dc3545; width: auto; padding: 8px 15px; font-size: 14px; margin: 0; color: white;}
    
    .form-control {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
      font-family: inherit;
    }
    
    .nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }
    .nav-header h2 { margin: 0; font-size: 1.3em; }

    /* æœ¬ã®ãƒªã‚¹ãƒˆè¡¨ç¤ºç”¨ */
    .book-item-container {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
    }
    .book-item-container:last-child { border-bottom: none; }
    .book-header {
      display: flex;
      align-items: flex-start;
    }
    .book-header img {
      width: 60px;
      height: auto;
      margin-right: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .book-info {
      flex-grow: 1;
    }
    .book-info strong { display: block; font-size: 1.1em; margin-bottom: 5px; }
    .book-info small { color: #666; display: block; line-height: 1.4; }
    .empty-msg { text-align: center; color: #888; }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; top: 0;
      width: 100%; height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.6); 
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; 
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-sizing: border-box;
      position: relative;
    }
    .close-btn {
      color: #aaa;
      position: absolute;
      top: 15px; right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-btn:hover { color: #333; }
    
    .modal-content label {
      font-weight: bold;
      color: #555;
      display: block;
      margin-bottom: 4px;
      font-size: 0.9em;
    }
    .detail-row {
      display: flex; gap: 15px; margin-bottom: 10px;
    }
    .detail-row > div { flex: 1; }
  </style>
</head>
<body>

  <!-- 4. ãƒˆãƒƒãƒ—ç”»é¢ -->
  <div id="screen-top" class="screen active">
    <h1>ğŸ“š ãƒ–ãƒƒã‚¯ã‚·ã‚§ãƒ«ãƒ•v3</h1>
    <div class="card stats">
      <p>è”µæ›¸æ•°: <strong id="count-collection" style="color: var(--primary-color);">0</strong> å†Š</p>
      <p>ã»ã—ã„æœ¬: <strong id="count-wish" style="color: #ff9800;">0</strong> å†Š</p>
    </div>
    <button class="btn" onclick="showScreen('screen-scan')">ğŸ“· 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
    <button class="btn" onclick="showScreen('screen-wish')" style="background-color: #ff9800;">â­ 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
    <button class="btn" onclick="showScreen('screen-collection')" style="background-color: #28a745;">ğŸ“– 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</button>
  </div>

  <!-- 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ (å®Œå…¨æ—¥æœ¬èªåŒ–å¯¾å¿œ) -->
  <div id="screen-scan" class="screen">
    <div class="nav-header">
      <h2>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    <div class="card">
      <p style="font-size: 0.9em; color:#555; margin-top:0;">æœ¬ã®è£ã«ã‚ã‚‹ä¸Šæ®µã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆ978ã¾ãŸã¯979ã‹ã‚‰å§‹ã¾ã‚‹ISBNï¼‰ã‚’å†™ã—ã¦ãã ã•ã„ã€‚</p>
      
      <!-- æ—¥æœ¬èªã®è‡ªä½œã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
      <div id="camera-select-container" style="margin-bottom: 15px;">
        <select id="camera-select" class="form-control"></select>
        <button class="btn" id="start-scan-btn" onclick="startScanner()">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button class="btn btn-back" id="stop-scan-btn" onclick="stopScanner()" style="display:none; width: 100%; margin-bottom: 10px;">ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
      </div>
      
      <div id="reader" style="width:100%; border-radius: 8px; overflow: hidden;"></div>
    </div>
    <div id="scan-result" class="card" style="display:none;"></div>
  </div>

  <!-- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆç”»é¢ -->
  <div id="screen-wish" class="screen">
    <div class="nav-header">
      <h2>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    
    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ -->
    <div class="card">
      <h3>ğŸ” æœ¬ã‚’æ¤œç´¢ã—ã¦è¿½åŠ </h3>
      <input type="text" id="wish-search-input" class="form-control" placeholder="æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…åã‚’å…¥åŠ›">
      <button class="btn" onclick="searchWishBook()">æ¤œç´¢</button>
      <div id="wish-search-results"></div>
    </div>

    <!-- æ‰‹å‹•è¿½åŠ  -->
    <div class="card">
      <h3>âœï¸ æ‰‹å‹•ã§è¿½åŠ </h3>
      <input type="text" id="manual-title" class="form-control" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (å¿…é ˆ)">
      <input type="text" id="manual-author" class="form-control" placeholder="è‘—è€…å">
      <input type="text" id="manual-publisher" class="form-control" placeholder="å‡ºç‰ˆç¤¾">
      <button class="btn" onclick="addManualWish()" style="background-color: #6c757d;">æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹</button>
    </div>

    <!-- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¸€è¦§ -->
    <div class="card">
      <h3>â­ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¸€è¦§</h3>
      <div id="wish-list-container"></div>
    </div>
  </div>

  <!-- 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢ç”»é¢ -->
  <div id="screen-collection" class="screen">
    <div class="nav-header">
      <h2>è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</h2>
      <button class="btn btn-back" onclick="showScreen('screen-top')">æˆ»ã‚‹</button>
    </div>
    <div class="card">
      <input type="text" id="collection-search-input" class="form-control" placeholder="ğŸ” è”µæ›¸ã®ä¸­ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚„è‘—è€…åã§æ¤œç´¢" oninput="renderCollection()">
    </div>
    <div class="card" id="collection-list-container"></div>
  </div>

  <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— (ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»é¢) -->
  <div id="book-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h3 id="modal-title" style="margin-bottom: 5px; padding-right: 20px; text-align: left;">ã‚¿ã‚¤ãƒˆãƒ«</h3>
      <p id="modal-author" style="color:#666; font-size:0.9em; margin-top: 0;"></p>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
        <div class="detail-row">
          <div>
            <label>çŠ¶æ…‹</label>
            <select id="modal-status" class="form-control" style="margin-bottom: 0;">
              <option value="unread">æœªèª­</option>
              <option value="read">æ—¢èª­</option>
            </select>
          </div>
          <div>
            <label>è©•ä¾¡</label>
            <select id="modal-rating" class="form-control" style="margin-bottom: 0;">
              <option value="0">æœªè©•ä¾¡</option>
              <option value="1">â˜…1</option>
              <option value="2">â˜…2</option>
              <option value="3">â˜…3</option>
              <option value="4">â˜…4</option>
              <option value="5">â˜…5 (æœ€é«˜)</option>
            </select>
          </div>
        </div>
        <label style="margin-top: 10px;">èª­ã‚“ã æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢</label>
        <textarea id="modal-review" class="form-control" rows="4" placeholder="æ„Ÿæƒ³ã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
      </div>
      
      <div class="action-buttons" style="justify-content: space-between; margin-top: 20px;">
        <button class="btn" style="background-color: var(--primary-color); flex:1; margin-right: 10px; margin-bottom: 0;" onclick="saveModal()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        <button class="btn btn-delete" style="flex:0 0 auto;" onclick="deleteFromModal()">è”µæ›¸ã‹ã‚‰å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let collection = JSON.parse(localStorage.getItem('bookshelf_collection')) ||[];
    let wishlist = JSON.parse(localStorage.getItem('bookshelf_wishlist')) ||[];

    function saveData() {
      localStorage.setItem('bookshelf_collection', JSON.stringify(collection));
      localStorage.setItem('bookshelf_wishlist', JSON.stringify(wishlist));
      updateCounts();
    }

    // --- ç”»é¢é·ç§»ç®¡ç† ---
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      
      if (screenId !== 'screen-scan') {
        stopScanner();
      }

      document.getElementById(screenId).classList.add('active');

      if (screenId === 'screen-top') {
        updateCounts();
      } else if (screenId === 'screen-scan') {
        initCameraList(); // ã‚«ãƒ¡ãƒ©ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
      } else if (screenId === 'screen-wish') {
        renderWishlist();
      } else if (screenId === 'screen-collection') {
        document.getElementById('collection-search-input').value = ""; 
        renderCollection();
      }
    }

    function updateCounts() {
      document.getElementById('count-collection').innerText = collection.length;
      document.getElementById('count-wish').innerText = wishlist.length;
    }

    // --- 1. ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ (è‡ªä½œUI) ---
    let html5QrCode = null;

    async function initCameraList() {
      const select = document.getElementById('camera-select');
      if(select.options.length > 0) return; // å–å¾—æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
      
      try {
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          select.innerHTML = '';
          devices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.id;
            // æ—¥æœ¬èªã®ãƒ©ãƒ™ãƒ«ãŒãªã‘ã‚Œã°é€£ç•ªã«ã™ã‚‹
            option.text = device.label || `ã‚«ãƒ¡ãƒ© ${index + 1}`;
            select.appendChild(option);
          });
          // èƒŒé¢ã‚«ãƒ¡ãƒ©(ã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©)ã‚’å„ªå…ˆçš„ã«é¸æŠ
          for(let i=0; i<devices.length; i++) {
            const label = devices[i].label.toLowerCase();
            if(label.includes('back') || label.includes('èƒŒé¢') || label.includes('environment')) {
              select.selectedIndex = i;
              break;
            }
          }
        } else {
          document.getElementById('camera-select-container').innerHTML = "<p style='color:red;'>ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
        }
      } catch (err) {
        console.warn("ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼", err);
      }
    }

    function startScanner() {
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
      }
      const cameraId = document.getElementById('camera-select').value;
      if (!cameraId) {
        alert("ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      
      document.getElementById('start-scan-btn').style.display = 'none';
      document.getElementById('stop-scan-btn').style.display = 'inline-block';
      document.getElementById('camera-select').style.display = 'none';
      document.getElementById('scan-result').style.display = 'none';

      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 250, height: 150 } },
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        console.error(err);
        alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        resetCameraUI();
      });
    }

    function stopScanner() {
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
          resetCameraUI();
        }).catch(err => console.error(err));
      } else {
        resetCameraUI();
      }
    }

    function resetCameraUI() {
      document.getElementById('start-scan-btn').style.display = 'inline-block';
      document.getElementById('stop-scan-btn').style.display = 'none';
      document.getElementById('camera-select').style.display = 'inline-block';
    }

    function onScanSuccess(decodedText) {
      if (decodedText.startsWith("978") || decodedText.startsWith("979")) {
        stopScanner();
        fetchBookByISBN(decodedText);
      }
    }

    function onScanFailure(error) { /* èª­ã¿å–ã‚Šä¸­ã¯æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§ç„¡è¦– */ }

    // OpenBD ã¨ Google Books API ã®äºŒæ®µæ§‹ãˆ
    async function fetchBookByISBN(isbn) {
      const resultDiv = document.getElementById('scan-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = "<p>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰æœ¬ã®æƒ…å ±ã‚’å–å¾—ä¸­...</p>";
      
      let bookData = null;

      try {
        const obdRes = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
        const obdData = await obdRes.json();
        if (obdData && obdData[0]) {
          const summary = obdData[0].summary;
          bookData = {
            title: summary.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜",
            author: summary.author || "è‘—è€…ä¸æ˜",
            publisher: summary.publisher || "å‡ºç‰ˆç¤¾ä¸æ˜",
            thumbnail: summary.cover || ""
          };
        }
      } catch (e) { console.warn("OpenBDã‚¨ãƒ©ãƒ¼:", e); }

      if (!bookData) {
        try {
          const gbRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
          const gbData = await gbRes.json();
          if (gbData.items && gbData.items.length > 0) {
            const info = gbData.items[0].volumeInfo;
            bookData = {
              title: info.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜",
              author: info.authors ? info.authors.join(", ") : "è‘—è€…ä¸æ˜",
              publisher: info.publisher || "å‡ºç‰ˆç¤¾ä¸æ˜",
              thumbnail: info.imageLinks ? info.imageLinks.thumbnail : ""
            };
          }
        } catch (e) { console.warn("Google Booksã‚¨ãƒ©ãƒ¼:", e); }
      }

      resultDiv.innerHTML = ""; // ã‚¯ãƒªã‚¢
      if (bookData) {
        const titleSafe = escapeHtml(bookData.title);
        const authorSafe = escapeHtml(bookData.author);
        const pubSafe = escapeHtml(bookData.publisher);

        resultDiv.innerHTML = `
          <h3>å–å¾—çµæœ</h3>
          <div class="book-item-container">
            <div class="book-header">
              ${bookData.thumbnail ? `<img src="${bookData.thumbnail}">` : `<div style="width:60px;height:80px;background:#ccc;margin-right:15px;"></div>`}
              <div class="book-info">
                <strong>${titleSafe}</strong>
                <small>è‘—è€…: ${authorSafe}</small>
                <small>å‡ºç‰ˆç¤¾: ${pubSafe}</small>
              </div>
            </div>
          </div>
        `;
        
        // å®‰å…¨ã«ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆï¼ˆç‰¹æ®Šæ–‡å­—ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
        const btnAdd = document.createElement('button');
        btnAdd.className = "btn";
        btnAdd.style.backgroundColor = "#28a745";
        btnAdd.textContent = "ã“ã®æœ¬ã‚’è”µæ›¸ã«ç™»éŒ²ã™ã‚‹";
        btnAdd.onclick = () => addToCollection(isbn, bookData.title, bookData.author, bookData.publisher, bookData.thumbnail);
        resultDiv.appendChild(btnAdd);

        const btnRetry = document.createElement('button');
        btnRetry.className = "btn btn-back";
        btnRetry.textContent = "ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹";
        btnRetry.onclick = () => { resultDiv.style.display='none'; startScanner(); };
        resultDiv.appendChild(btnRetry);

      } else {
        resultDiv.innerHTML = `<p style="color:red;">æœ¬ã®æƒ…å ±ï¼ˆISBN: ${isbn}ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
        const btnRetry = document.createElement('button');
        btnRetry.className = "btn btn-back";
        btnRetry.textContent = "å†ã‚¹ã‚­ãƒ£ãƒ³";
        btnRetry.onclick = () => { resultDiv.style.display='none'; startScanner(); };
        resultDiv.appendChild(btnRetry);
      }
    }

    function addToCollection(isbn, title, author, publisher, thumbnail) {
      collection.push({ 
        id: Date.now(), isbn, title, author, publisher, thumbnail,
        status: 'unread', review: '', rating: 0
      });
      saveData();
      alert("è”µæ›¸ã«ç™»éŒ²ã—ã¾ã—ãŸï¼");
      showScreen('screen-top');
    }

    // --- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆæ©Ÿèƒ½ (æ¤œç´¢ã‚¨ãƒ©ãƒ¼æ”¹å–„) ---
    async function searchWishBook() {
      const query = document.getElementById('wish-search-input').value.trim();
      if (!query) return;
      const resultsDiv = document.getElementById('wish-search-results');
      resultsDiv.innerHTML = "<p>æ¤œç´¢ä¸­...</p>";
      
      try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
        if (!response.ok) throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${response.status})`);
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
          resultsDiv.innerHTML = "";
          data.items.forEach(item => {
            const info = item.volumeInfo;
            const title = info.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
            const author = info.authors ? info.authors.join(", ") : "è‘—è€…ä¸æ˜";
            const publisher = info.publisher || "å‡ºç‰ˆç¤¾ä¸æ˜";
            const thumbnail = info.imageLinks ? info.imageLinks.thumbnail : "";
            const isbnObj = info.industryIdentifiers ? info.industryIdentifiers.find(i => i.type === "ISBN_13") : null;
            const isbn = isbnObj ? isbnObj.identifier : "";

            const div = document.createElement('div');
            div.className = "book-item-container";
            div.innerHTML = `
              <div class="book-header">
                ${thumbnail ? `<img src="${thumbnail}">` : `<div style="width:60px;height:80px;background:#ccc;margin-right:15px;"></div>`}
                <div class="book-info">
                  <strong>${escapeHtml(title)}</strong>
                  <small>è‘—è€…: ${escapeHtml(author)}</small>
                  <small>å‡ºç‰ˆç¤¾: ${escapeHtml(publisher)}</small>
                </div>
              </div>
            `;
            
            // å®‰å…¨ã«ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã—ã¦è¿½åŠ 
            const btn = document.createElement('button');
            btn.className = "btn";
            btn.style.backgroundColor = "#ff9800";
            btn.style.marginTop = "10px";
            btn.style.padding = "8px";
            btn.textContent = "ã“ã®æœ¬ã‚’ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ";
            btn.onclick = () => addToWishlist(title, author, publisher, thumbnail, isbn);
            
            div.appendChild(btn);
            resultsDiv.appendChild(div);
          });
        } else {
          resultsDiv.innerHTML = "<p>è©²å½“ã™ã‚‹æœ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã™ã‚‹ã‹ã€æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>";
        }
      } catch(e) {
        console.error(e);
        resultsDiv.innerHTML = `<p style="color:red;">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>è©³ç´°: ${escapeHtml(e.message)}</p>`;
      }
    }

    function addManualWish() {
      const title = document.getElementById('manual-title').value;
      const author = document.getElementById('manual-author').value || "è‘—è€…ä¸æ˜";
      const publisher = document.getElementById('manual-publisher').value || "å‡ºç‰ˆç¤¾ä¸æ˜";
      if (!title) { alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      
      addToWishlist(title, author, publisher, "", "");
      document.getElementById('manual-title').value = "";
      document.getElementById('manual-author').value = "";
      document.getElementById('manual-publisher').value = "";
    }

    function addToWishlist(title, author, publisher, thumbnail, isbn) {
      wishlist.push({ id: Date.now(), title, author, publisher, thumbnail, isbn });
      saveData();
      alert("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼");
      renderWishlist();
      document.getElementById('wish-search-results').innerHTML = "";
      document.getElementById('wish-search-input').value = "";
    }

    function renderWishlist() {
      const container = document.getElementById('wish-list-container');
      container.innerHTML = "";
      
      if(wishlist.length === 0) {
        container.innerHTML = "<p class='empty-msg'>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ã€‚</p>";
        return;
      }
      
      wishlist.forEach((book, index) => {
        const div = document.createElement('div');
        div.className = "book-item-container";
        div.innerHTML = `
          <div class="book-header">
            ${book.thumbnail ? `<img src="${book.thumbnail}">` : `<div style="width:60px;height:80px;background:#eee;margin-right:15px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa;">ç”»åƒãªã—</div>`}
            <div class="book-info">
              <strong>${escapeHtml(book.title)}</strong>
              <small>è‘—è€…: ${escapeHtml(book.author)}</small>
              <small>å‡ºç‰ˆç¤¾: ${escapeHtml(book.publisher || 'ä¸æ˜')}</small>
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn" style="background-color: #28a745; margin:0; flex:1;" onclick="moveToCollection(${index})">ğŸ“– è”µæ›¸ã¸ç§»å‹•</button>
            <button class="btn btn-delete" style="flex:0 0 auto;" onclick="removeWish(${index})">å‰Šé™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function moveToCollection(index) {
      const book = wishlist[index];
      collection.push({ ...book, id: Date.now(), status: 'unread', review: '', rating: 0 });
      wishlist.splice(index, 1);
      saveData();
      renderWishlist();
      alert("è”µæ›¸ãƒªã‚¹ãƒˆã¸ç§»å‹•ã—ã¾ã—ãŸï¼");
    }

    function removeWish(index) {
      if (confirm("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        wishlist.splice(index, 1);
        saveData();
        renderWishlist();
      }
    }

    // --- 3. è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢æ©Ÿèƒ½ (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç·¨é›†) ---
    function renderCollection() {
      const query = document.getElementById('collection-search-input').value.toLowerCase();
      const container = document.getElementById('collection-list-container');
      container.innerHTML = "";
      
      const filtered = collection.filter(book => 
        book.title.toLowerCase().includes(query) || 
        book.author.toLowerCase().includes(query) ||
        (book.publisher && book.publisher.toLowerCase().includes(query))
      );

      if(filtered.length === 0) {
        container.innerHTML = "<p class='empty-msg'>è©²å½“ã™ã‚‹è”µæ›¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      filtered.forEach((book) => {
        const originalIndex = collection.indexOf(book);
        const div = document.createElement('div');
        div.className = "book-item-container";
        
        let ratingStar = book.rating > 0 ? `<span style="color:#ff9800; margin-left:10px;">è©•ä¾¡: ${'â˜…'.repeat(book.rating)}${'â˜†'.repeat(5 - book.rating)}</span>` : "";
        let statusBadge = book.status === 'read' 
          ? `<span style="background:#28a745; color:white; padding:2px 6px; border-radius:4px; font-size:12px;">æ—¢èª­</span>` 
          : `<span style="background:#6c757d; color:white; padding:2px 6px; border-radius:4px; font-size:12px;">æœªèª­</span>`;

        div.innerHTML = `
          <div class="book-header">
            ${book.thumbnail ? `<img src="${book.thumbnail}">` : `<div style="width:60px;height:80px;background:#eee;margin-right:15px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa;">ç”»åƒãªã—</div>`}
            <div class="book-info">
              <strong>${escapeHtml(book.title)}</strong>
              <small>è‘—è€…: ${escapeHtml(book.author)}</small>
              <small>å‡ºç‰ˆç¤¾: ${escapeHtml(book.publisher || 'ä¸æ˜')}</small>
              <div style="margin-top:8px;">${statusBadge}${ratingStar}</div>
            </div>
          </div>
          <button class="btn" style="margin-top:10px; margin-bottom:0; padding:8px; background-color: #17a2b8;" onclick="openModal(${originalIndex})">ğŸ“ è©³ç´°ãƒ»ç·¨é›†ï¼ˆæ„Ÿæƒ³ãƒ»è©•ä¾¡ãªã©ï¼‰</button>
        `;
        container.appendChild(div);
      });
    }

    // --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—(ãƒ¢ãƒ¼ãƒ€ãƒ«)å‡¦ç† ---
    let currentEditIndex = -1;

    function openModal(index) {
      const book = collection[index];
      currentEditIndex = index;
      
      document.getElementById('modal-title').innerText = book.title;
      document.getElementById('modal-author').innerText = `è‘—è€…: ${book.author}`;
      
      document.getElementById('modal-status').value = book.status || 'unread';
      document.getElementById('modal-rating').value = book.rating || '0';
      document.getElementById('modal-review').value = book.review || '';
      
      document.getElementById('book-modal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('book-modal').style.display = 'none';
    }

    function saveModal() {
      if (currentEditIndex > -1) {
        collection[currentEditIndex].status = document.getElementById('modal-status').value;
        collection[currentEditIndex].rating = document.getElementById('modal-rating').value;
        collection[currentEditIndex].review = document.getElementById('modal-review').value;
        saveData();
        renderCollection();
      }
      closeModal();
    }

    function deleteFromModal() {
      if (confirm("æœ¬å½“ã«ã“ã®æœ¬ã‚’è”µæ›¸ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        collection.splice(currentEditIndex, 1);
        saveData();
        renderCollection();
        closeModal();
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    window.onclick = function(event) {
      const modal = document.getElementById('book-modal');
      if (event.target == modal) {
        closeModal();
      }
    }

    // --- è£œåŠ©é–¢æ•° (ã‚µãƒ‹ã‚¿ã‚¤ã‚º) ---
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // --- åˆæœŸåŒ– ---
    window.onload = () => {
      updateCounts();
    };
  </script>
</body>
</html>
