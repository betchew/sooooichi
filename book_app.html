<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.12</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --accent: #f59e0b; --wish: #10b981; --amazon: #ff9900; }
        body { font-family: sans-serif; margin: 0; background-color: var(--bg); color: #334155; line-height: 1.6; }
        .nav-header { background: var(--primary); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .container { max-width: 800px; margin: auto; padding: 15px; }
        .page { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center; transition: 0.2s; border: 1px solid transparent; }
        .btn-full { display: block; width: 100%; margin: 8px 0; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-wish { background: var(--wish); color: white; }
        .btn-amazon { background: var(--amazon); color: white; font-weight: bold; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; }
        .btn-small { padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; }

        /* ã‚¿ãƒ–UI */
        .tab-menu { display: flex; gap: 5px; margin-bottom: 15px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
        .tab-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; background: none; cursor: pointer; font-size: 0.85rem; }
        .tab-btn.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .text-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; min-height: 250px; }
        
        /* ãƒªã‚¹ãƒˆã¨ã‚µãƒ ãƒã‚¤ãƒ« */
        .list-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; gap: 12px; }
        .book-thumb { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; background: #e2e8f0; flex-shrink: 0; }
        .item-info { flex: 1; font-size: 0.85rem; }
        .item-title { font-weight: bold; display: block; line-height: 1.2; margin-bottom: 4px; }
        .star-rating { color: var(--accent); font-size: 0.8rem; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal-thumb { width: 100px; height: 140px; object-fit: cover; display: block; margin: 0 auto 15px auto; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .rating-select span { cursor: pointer; font-size: 1.5rem; color: #cbd5e1; }
        .rating-select span.selected { color: var(--accent); }
    </style>
</head>
<body>

<div class="nav-header">è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>

<div class="container">
    <!-- 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
    <section id="page-top" class="page active">
        <div class="card" style="text-align: center;">
            <button class="btn btn-primary btn-full" onclick="navTo('page-scan')">ğŸ“¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
            <button class="btn btn-wish btn-full" onclick="navTo('page-wishlist')">ğŸŒŸ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
            <button class="btn btn-outline btn-full" onclick="navTo('page-history')">ğŸ“‚ è”µæ›¸ä¸€è¦§ãƒ»æ„Ÿæƒ³ãƒ»æ¤œç´¢</button>
        </div>
        <div class="card">
            <p>è”µæ›¸æ•°: <strong><span id="current-count">0</span></strong> / ã‚¦ã‚£ãƒƒã‚·ãƒ¥: <strong><span id="wish-count">0</span></strong></p>
        </div>
    </section>

    <!-- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ -->
    <section id="page-wishlist" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card">
            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchWishTab('tab-search')">ãƒãƒƒãƒˆæ¤œç´¢</button>
                <button class="tab-btn" onclick="switchWishTab('tab-amazon')">Amazon URL</button>
                <button class="tab-btn" onclick="switchWishTab('tab-manual')">æ‰‹æ›¸ã</button>
            </div>
            <div id="tab-search" class="tab-content active">
                <div style="display:flex; gap:5px;"><input type="text" id="wishSearchInput" class="text-input" placeholder="é¡Œåãƒ»ä½œè€…å"><button class="btn btn-primary" onclick="searchWishCandidates()">æ¤œç´¢</button></div>
                <div id="wishCandidates" style="max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:8px; margin-top:10px; display:none;"></div>
            </div>
            <div id="tab-amazon" class="tab-content">
                <input type="text" id="amazonUrlInput" class="text-input" placeholder="Amazonã®URLã‚’è²¼ã‚Šä»˜ã‘"><button class="btn btn-amazon btn-full" onclick="addFromAmazonUrl()">URLã‹ã‚‰æƒ…å ±ã‚’å–å¾—</button>
                <div id="amazon-status" style="font-size:0.8rem; margin-top:5px;"></div>
            </div>
            <div id="tab-manual" class="tab-content">
                <input type="text" id="manualTitle" class="text-input" placeholder="é¡Œåï¼ˆå¿…é ˆï¼‰"><input type="text" id="manualAuthor" class="text-input" placeholder="ä½œè€…å"><button class="btn btn-wish btn-full" onclick="addManualWish()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            </div>
        </div>
        <div class="card"><h3>è²·ã„ãŸã„æœ¬</h3><div id="wishListUI"></div></div>
    </section>

    <!-- 3. ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ -->
    <section id="page-scan" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card"><div id="reader"></div><div id="scan-status" style="margin-top:10px; font-weight:bold; color:var(--primary);">ã‚«ãƒ¡ãƒ©æº–å‚™ä¸­...</div></div>
    </section>

    <!-- 4. è”µæ›¸ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
    <section id="page-history" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card">
            <input type="text" id="searchInput" class="text-input" placeholder="è”µæ›¸ãƒ»æ„Ÿæƒ³ã‚’æ¤œç´¢..." oninput="handleSearch()">
            <div id="historyListUI" style="margin-top:10px;"></div>
        </div>
        <button class="btn btn-outline btn-full" onclick="exportToFile()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜(JSON)</button>
        <div class="card"><h3>ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ</h3><input type="file" id="fileInput" accept=".json"></div>
    </section>
</div>

<!-- è©³ç´°ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal">
    <div class="modal-content">
        <img id="modalThumb" class="modal-thumb" src="" alt="">
        <h3 id="modalHead" style="text-align:center; margin-top:0;">è©³ç´°è¨­å®š</h3>
        <input type="hidden" id="edit-index"><input type="hidden" id="edit-mode">
        <div class="rating-select" id="ratingSelect" style="text-align:center;">
            <span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span><span data-v="4">â˜…</span><span data-v="5">â˜…</span>
        </div>
        <input type="hidden" id="edit-rating" value="0">
        <label style="font-size:0.8rem; font-weight:bold;">é¡Œå</label><input type="text" id="edit-title" class="text-input">
        <label style="font-size:0.8rem; font-weight:bold;">ä½œè€…</label><input type="text" id="edit-author" class="text-input">
        <label style="font-size:0.8rem; font-weight:bold;">æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢</label><textarea id="edit-impression" class="text-input" style="height:100px;"></textarea>
        <div style="display: flex; gap: 10px;"><button class="btn btn-primary" style="flex: 2;" onclick="saveEdit()">ä¿å­˜</button><button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">æˆ»ã‚‹</button></div>
        <button class="btn btn-full" style="color:red; background:none; margin-top:10px; font-size:0.8rem;" onclick="deleteEntry()">å‰Šé™¤ã™ã‚‹</button>
    </div>
</div>

<script>
    let books = JSON.parse(localStorage.getItem('myBooks') || '[]');
    let wishlist = JSON.parse(localStorage.getItem('myWishlist') || '[]');
    let html5QrCode = null;

    window.onload = () => {
        initRatingEvents();
        updateUI();
    };

    async function navTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if (html5QrCode) { try { await html5QrCode.stop(); html5QrCode = null; } catch(e){} }
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'page-scan') startScanner();
        updateUI();
    }

    function switchWishTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // --- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ: ãƒãƒƒãƒˆæ¤œç´¢ (ç”»åƒå–å¾—å¯¾å¿œ) ---
    async function searchWishCandidates() {
        const query = document.getElementById('wishSearchInput').value.trim();
        const target = document.getElementById('wishCandidates');
        if (!query) return;
        target.style.display = "block";
        target.innerHTML = "<div style='padding:10px;'>æ¤œç´¢ä¸­...</div>";
        try {
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=20`);
            const data = await res.json();
            if (!data.items) { target.innerHTML = "<div style='padding:10px;'>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>"; return; }
            target.innerHTML = data.items.map(item => {
                const info = item.volumeInfo;
                const book = {
                    title: info.title || "ä¸æ˜",
                    author: info.authors ? info.authors.join(', ') : "ä¸æ˜",
                    isbn: info.industryIdentifiers ? info.industryIdentifiers[0].identifier : "",
                    thumbnail: info.imageLinks ? info.imageLinks.thumbnail.replace('http:', 'https:') : ""
                };
                return `<div class="list-item" style="font-size:0.8rem;">
                    <img src="${book.thumbnail || ''}" class="book-thumb" alt="">
                    <div class="item-info"><strong>${book.title}</strong><br>${book.author}</div>
                    <button class="btn btn-wish btn-small" onclick='addBookToWish(${JSON.stringify(book).replace(/'/g, "&apos;")})'>è¿½åŠ </button>
                </div>`;
            }).join('');
        } catch (e) { target.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"; }
    }

    // --- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ: Amazon/æ‰‹æ›¸ã ---
    async function addFromAmazonUrl() {
        const url = document.getElementById('amazonUrlInput').value.trim();
        const status = document.getElementById('amazon-status');
        const match = url.match(/\/(?:dp|gp\/product|ASIN)\/([A-Z0-9]{10,13})/i);
        if (match) {
            const code = match[1];
            status.innerText = "æƒ…å ±å–å¾—ä¸­...";
            try {
                // ã¾ãš openBD ã§ç”»åƒã‚’å«ã‚ã¦å–å¾—è©¦è¡Œ
                const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${code}`);
                const data = await res.json();
                if (data && data[0]) {
                    const info = data[0].summary;
                    addBookToWish({title:info.title, author:info.author, isbn:info.isbn, thumbnail:info.cover || ""});
                    document.getElementById('amazonUrlInput').value = ""; status.innerText = "âœ… è¿½åŠ å®Œäº†";
                } else {
                    // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° Google Books ã§ç”»åƒå«ã‚ã¦å–å¾—
                    const gRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${code}`);
                    const gData = await gRes.json();
                    if (gData.items) {
                        const info = gData.items[0].volumeInfo;
                        addBookToWish({title:info.title, author:info.authors?.join(','), isbn:code, thumbnail:info.imageLinks?.thumbnail.replace('http:','https:') || ""});
                        document.getElementById('amazonUrlInput').value = ""; status.innerText = "âœ… è¿½åŠ å®Œäº†";
                    } else { status.innerText = "âŒ æƒ…å ±ãªã—"; }
                }
            } catch(e) { status.innerText = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
        }
    }

    function addManualWish() {
        const title = document.getElementById('manualTitle').value.trim();
        const author = document.getElementById('manualAuthor').value.trim();
        if (!title) return alert("é¡Œåã¯å¿…é ˆã§ã™");
        addBookToWish({title, author, isbn:"", thumbnail:""});
        document.getElementById('manualTitle').value = ""; document.getElementById('manualAuthor').value = "";
    }

    function addBookToWish(book) {
        wishlist.push({...book, date:"æœªè³¼å…¥", rating:0, impression:""});
        saveData(); alert("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ");
    }

    // --- è”µæ›¸ä¸€è¦§ (ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºå¯¾å¿œ) ---
    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = books.filter(b => (b.title + b.author + (b.impression || "")).toLowerCase().includes(term));
        document.getElementById('historyListUI').innerHTML = filtered.map((b) => {
            const idx = books.indexOf(b);
            const thumbHtml = b.thumbnail ? `<img src="${b.thumbnail}" class="book-thumb">` : `<div class="book-thumb" style="display:flex; align-items:center; justify-content:center; font-size:10px; color:#999;">No Image</div>`;
            return `<div class="list-item">
                ${thumbHtml}
                <div class="item-info">
                    <span class="item-title">${b.title}</span>
                    <span class="star-rating">${"â˜…".repeat(b.rating).padEnd(5,"â˜†")}</span><br>
                    <small>${b.author}</small>
                </div>
                <button class="btn btn-outline btn-small" onclick="openEdit(${idx}, 'books')">è©³ç´°</button>
            </div>`;
        }).reverse().join('');
    }

    // --- ã‚¹ã‚­ãƒ£ãƒ³ (ç”»åƒå–å¾—å¯¾å¿œ) ---
    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (isbn) => {
            if (isbn.startsWith("978")) fetchBookInfo(isbn);
        }).catch(err => { document.getElementById('scan-status').innerText = "ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"; });
    }

    async function fetchBookInfo(isbn) {
        try {
            const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
            const data = await res.json();
            if (data && data[0]) {
                const info = data[0].summary;
                if (!books.some(b => b.isbn === info.isbn)) {
                    books.push({title:info.title, author:info.author, publisher:info.publisher, date:new Date().toLocaleDateString('ja-JP'), isbn:info.isbn, thumbnail:info.cover || "", rating:0, impression:""});
                    saveData(); document.getElementById('scan-status').innerText = "âœ… ç™»éŒ²: " + info.title;
                }
            }
        } catch(e){}
    }

    // --- å…±é€šãƒ»UI ---
    function saveData() {
        localStorage.setItem('myBooks', JSON.stringify(books));
        localStorage.setItem('myWishlist', JSON.stringify(wishlist));
        updateUI();
    }

    function updateUI() {
        document.getElementById('current-count').innerText = books.length;
        document.getElementById('wish-count').innerText = wishlist.length;
        const wishUI = document.getElementById('wishListUI');
        wishUI.innerHTML = wishlist.map((b, i) => `
            <div class="list-item">
                <img src="${b.thumbnail || ''}" class="book-thumb" alt="">
                <div class="item-info"><span class="item-title">${b.title}</span><small>${b.author}</small></div>
                <div style="display:flex; gap:5px;"><button class="btn btn-primary btn-small" onclick="moveToLibrary(${i})">è³¼å…¥</button><button class="btn btn-outline btn-small" onclick="openEdit(${i}, 'wish')">ç·¨é›†</button></div>
            </div>
        `).reverse().join('');
        if (document.getElementById('page-history').classList.contains('active')) handleSearch();
    }

    function moveToLibrary(i) {
        const b = wishlist[i]; b.date = new Date().toLocaleDateString('ja-JP');
        books.push(b); wishlist.splice(i, 1); saveData();
    }

    function openEdit(index, mode) {
        const b = (mode === 'books') ? books[index] : wishlist[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('edit-mode').value = mode;
        document.getElementById('edit-title').value = b.title;
        document.getElementById('edit-author').value = b.author;
        document.getElementById('edit-impression').value = b.impression || "";
        document.getElementById('modalThumb').src = b.thumbnail || "";
        document.getElementById('modalThumb').style.display = b.thumbnail ? "block" : "none";
        setRatingUI(b.rating || 0);
        document.getElementById('editModal').style.display = 'flex';
    }

    function saveEdit() {
        const idx = document.getElementById('edit-index').value;
        const mode = document.getElementById('edit-mode').value;
        const target = (mode === 'books') ? books[idx] : wishlist[idx];
        target.title = document.getElementById('edit-title').value;
        target.author = document.getElementById('edit-author').value;
        target.impression = document.getElementById('edit-impression').value;
        target.rating = parseInt(document.getElementById('edit-rating').value);
        saveData(); closeModal();
    }

    function deleteEntry() {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const idx = document.getElementById('edit-index').value;
        if(document.getElementById('edit-mode').value === 'books') books.splice(idx, 1);
        else wishlist.splice(idx, 1);
        saveData(); closeModal();
    }

    function initRatingEvents() {
        document.querySelectorAll('#ratingSelect span').forEach(star => {
            star.onclick = function() { setRatingUI(this.getAttribute('data-v')); };
        });
    }

    function setRatingUI(val) {
        document.getElementById('edit-rating').value = val;
        document.querySelectorAll('#ratingSelect span').forEach(s => s.classList.toggle('selected', s.getAttribute('data-v') <= val));
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }
    function exportToFile() {
        const blob = new Blob([JSON.stringify({books, wishlist}, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'library_data_v12.json'; a.click();
    }
</script>
</body>
</html>
