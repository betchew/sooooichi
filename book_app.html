<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.22</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --accent: #f59e0b; --wish: #10b981; }
        body { font-family: sans-serif; margin: 0; background-color: var(--bg); color: #334155; line-height: 1.6; }
        .nav-header { background: var(--primary); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .container { max-width: 800px; margin: auto; padding: 15px; }
        .page { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        .btn { display: inline-block; padding: 12px 20px; border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer; text-align: center; transition: 0.2s; }
        .btn-full { display: block; width: 100%; margin: 8px 0; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-wish { background: var(--wish); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #334155; }
        .btn-small { padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; }

        .tab-menu { display: flex; gap: 5px; margin-bottom: 15px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
        .tab-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; background: none; cursor: pointer; font-size: 0.8rem; }
        .tab-btn.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .text-input, .select-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; background: white; outline: none; }
        
        .list-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; gap: 12px; }
        .book-thumb { width: 55px; height: 80px; object-fit: cover; border-radius: 4px; background: #e2e8f0; flex-shrink: 0; border: 1px solid #eee; }
        .item-info { flex: 1; font-size: 0.85rem; overflow: hidden; }
        .item-title { font-weight: bold; display: block; margin-bottom: 2px; line-height: 1.3; }
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: #e2e8f0; color: #475569; }
        .status-read { background: #dcfce7; color: #166534; }
        
        .reader-box { width: 100%; border-radius: 12px; overflow: hidden; background: #000; min-height: 250px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
        .modal-thumb-large { width: 120px; height: 170px; object-fit: cover; display: block; margin: 0 auto 15px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .rating-stars span { cursor: pointer; font-size: 1.5rem; color: #cbd5e1; }
        .rating-stars span.selected { color: var(--accent); }
        .modal-label { font-size: 0.8rem; font-weight: bold; color: #64748b; margin-top: 10px; display: block; }
    </style>
</head>
<body>

<div class="nav-header">è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.22</div>

<div class="container">
    <!-- 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
    <section id="page-top" class="page active">
        <div class="card" style="text-align: center;">
            <button class="btn btn-primary btn-full" onclick="navTo('page-scan')">ğŸ“¥ è”µæ›¸ã‚’ã‚¹ã‚­ãƒ£ãƒ³ç™»éŒ²</button>
            <button class="btn btn-wish btn-full" onclick="navTo('page-wishlist')">ğŸŒŸ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
            <button class="btn btn-outline btn-full" onclick="navTo('page-history')">ğŸ“‚ è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</button>
        </div>
        <div class="card">
            <p>è”µæ›¸æ•°: <strong><span id="current-count">0</span></strong> / ã‚¦ã‚£ãƒƒã‚·ãƒ¥: <strong><span id="wish-count">0</span></strong></p>
        </div>
    </section>

    <!-- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ -->
    <section id="page-wishlist" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card">
            <div class="tab-menu">
                <button class="tab-btn active" onclick="switchTab('tab-search')">ãƒãƒƒãƒˆæ¤œç´¢</button>
                <button class="tab-btn" onclick="switchTab('tab-scan-wish')">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</button>
                <button class="tab-btn" onclick="switchTab('tab-manual')">æ‰‹æ›¸ãç™»éŒ²</button>
            </div>
            
            <div id="tab-search" class="tab-content active">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="wishSearchInput" class="text-input" placeholder="é¡Œåã‚„ä½œè€…å">
                    <button class="btn btn-primary" onclick="searchWish()">æ¤œç´¢</button>
                </div>
                <div id="wishCandidates" style="max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:8px; display:none; margin-top:10px;"></div>
            </div>

            <div id="tab-scan-wish" class="tab-content">
                <div id="reader-wish" class="reader-box"></div>
                <div id="scan-status-wish" style="margin-top:10px; font-weight:bold; color:var(--wish); text-align:center;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>
            </div>

            <div id="tab-manual" class="tab-content">
                <label class="modal-label">é¡Œåï¼ˆå¿…é ˆï¼‰</label><input type="text" id="manualTitle" class="text-input">
                <label class="modal-label">ä½œè€…</label><input type="text" id="manualAuthor" class="text-input">
                <label class="modal-label">å‡ºç‰ˆç¤¾</label><input type="text" id="manualPublisher" class="text-input">
                <button class="btn btn-wish btn-full" onclick="addManual()">ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            </div>
        </div>
        <div class="card"><h3>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆä¸€è¦§</h3><div id="wishListUI"></div></div>
    </section>

    <!-- 3. è”µæ›¸ç”¨ã‚¹ã‚­ãƒ£ãƒ³ -->
    <section id="page-scan" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card">
            <div id="reader-books" class="reader-box"></div>
            <div id="scan-status-books" style="margin-top:10px; font-weight:bold; color:var(--primary); text-align:center;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>
        </div>
    </section>

    <!-- 4. è”µæ›¸ä¸€è¦§ -->
    <section id="page-history" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card"><input type="text" id="searchInput" class="text-input" placeholder="è”µæ›¸å†…ã‚’æ¤œç´¢..." oninput="handleSearch()"><div id="historyListUI" style="margin-top:10px;"></div></div>
        <button class="btn btn-outline btn-full" onclick="exportToFile()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(JSON)</button>
    </section>
</div>

<!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="confirmModal" class="modal"><div class="modal-content">
    <img id="confirmThumb" class="modal-thumb-large" src="">
    <h3 id="confirmTitle" style="text-align:center; margin-bottom:5px;"></h3>
    <p id="confirmAuthor" style="text-align:center; color:#666; font-size:0.9rem;"></p>
    <p id="confirmMessage" style="text-align:center; font-weight:bold; color:var(--primary);"></p>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-primary" style="flex:2;" onclick="executeRegister()">ç™»éŒ²ã™ã‚‹</button>
        <button class="btn btn-secondary" style="flex:1;" onclick="cancelRegister()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div></div>

<!-- è©³ç´°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" class="modal"><div class="modal-content">
    <img id="editThumb" class="modal-thumb-large" src="">
    <div class="rating-stars" id="ratingEdit" style="text-align:center;"><span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span><span data-v="4">â˜…</span><span data-v="5">â˜…</span></div>
    <input type="hidden" id="edit-index"><input type="hidden" id="edit-mode"><input type="hidden" id="edit-rating-val">
    <label class="modal-label">èª­æ›¸çŠ¶æ³</label><select id="edit-status" class="select-input"><option value="æœªèª­">æœªèª­</option><option value="èª­æ›¸ä¸­">èª­æ›¸ä¸­</option><option value="èª­äº†">èª­äº†</option></select>
    <label class="modal-label">èª­äº†æ—¥</label><input type="date" id="edit-read-date" class="text-input">
    <label class="modal-label">é¡Œå</label><input type="text" id="edit-title" class="text-input">
    <label class="modal-label">ä½œè€…</label><input type="text" id="edit-author" class="text-input">
    <label class="modal-label">å‡ºç‰ˆç¤¾</label><input type="text" id="edit-publisher" class="text-input">
    <label class="modal-label">æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢</label><textarea id="edit-impression" class="text-input" style="height:80px;"></textarea>
    <button class="btn btn-primary btn-full" onclick="saveEdit()">ä¿å­˜</button>
    <button class="btn btn-secondary btn-full" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    <button class="btn btn-full" style="color:red; background:none;" onclick="deleteEntry()">å‰Šé™¤</button>
</div></div>

<script>
    let books = JSON.parse(localStorage.getItem('myBooks') || '[]');
    let wishlist = JSON.parse(localStorage.getItem('myWishlist') || '[]');
    let tempSearchList =[];
    let currentScanner = null;
    let currentScanMode = ''; // 'books' or 'wishlist'
    let pendingBook = null;

    const NO_IMAGE = "https://via.placeholder.com/100x140.png?text=No+Image";

    window.onload = () => { initRatingEvents(); updateUI(); };

    // --- ã‚«ãƒ¡ãƒ©ç®¡ç† ---
    async function stopScanner() {
        if (currentScanner) {
            try { await currentScanner.stop(); currentScanner.clear(); } catch(e) {}
            currentScanner = null;
        }
    }

    async function startScanner(mode) {
        await stopScanner();
        currentScanMode = mode;
        const readerId = mode === 'books' ? 'reader-books' : 'reader-wish';
        const statusId = mode === 'books' ? 'scan-status-books' : 'scan-status-wish';
        
        document.getElementById(statusId).innerText = "ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...";
        currentScanner = new Html5Qrcode(readerId);
        
        currentScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (isbn) => {
            if (isbn.startsWith("978")) {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (mode === 'books' && books.some(b => b.isbn === isbn)) {
                    alert("æ—¢ã«è”µæ›¸ä¸€è¦§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"); return;
                }
                if (mode === 'wishlist' && wishlist.some(b => b.isbn === isbn)) {
                    alert("æ—¢ã«ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"); return;
                }
                currentScanner.pause();
                fetchBookByScan(isbn, statusId);
            }
        }).catch(() => { document.getElementById(statusId).innerText = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"; });
    }

    // --- æƒ…å ±å–å¾— (ã‚¹ã‚­ãƒ£ãƒ³ç”¨) ---
    async function fetchBookByScan(isbn, statusId) {
        document.getElementById(statusId).innerText = "æƒ…å ±ã‚’å–å¾—ä¸­...";
        try {
            let title="", author="", publisher="", thumbnail="";
            const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
            const data = await res.json();
            if (data && data[0]) {
                const s = data[0].summary;
                title = s.title; author = s.author; publisher = s.publisher; thumbnail = s.cover || "";
            }
            if (!thumbnail || !title) {
                const gRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
                const gData = await gRes.json();
                if (gData.items) {
                    const gi = gData.items[0].volumeInfo;
                    title = title || gi.title;
                    author = author || gi.authors?.join(', ');
                    publisher = publisher || gi.publisher;
                    const links = gi.imageLinks || {};
                    const gThumb = links.thumbnail || links.smallThumbnail || "";
                    if (!thumbnail && gThumb) thumbnail = gThumb.replace('http:', 'https:');
                }
            }

            if (title) {
                pendingBook = { title, author, publisher, isbn, thumbnail, date: new Date().toLocaleDateString('ja-JP'), rating:0, impression:"", status:"æœªèª­", readDate:"" };
                document.getElementById('confirmThumb').src = thumbnail || NO_IMAGE;
                document.getElementById('confirmTitle').innerText = title;
                document.getElementById('confirmAuthor').innerText = author;
                document.getElementById('confirmMessage').innerText = currentScanMode === 'books' ? "ã“ã®æœ¬ã‚’è”µæ›¸ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ" : "ã“ã®æœ¬ã‚’ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ";
                document.getElementById('confirmModal').style.display = "flex";
            } else {
                alert("æœ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                if(currentScanner) currentScanner.resume();
                document.getElementById(statusId).innerText = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„";
            }
        } catch(e) {
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            if(currentScanner) currentScanner.resume();
            document.getElementById(statusId).innerText = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„";
        }
    }

    function executeRegister() {
        if (pendingBook) {
            if (currentScanMode === 'books') {
                books.push(pendingBook);
                alert("è”µæ›¸ã«ç™»éŒ²ã—ã¾ã—ãŸ");
            } else {
                wishlist.push(pendingBook);
                alert("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ");
            }
            saveData();
            cancelRegister();
        }
    }

    function cancelRegister() {
        document.getElementById('confirmModal').style.display = "none";
        pendingBook = null;
        if (currentScanner) currentScanner.resume();
        document.getElementById('scan-status-books').innerText = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„";
        document.getElementById('scan-status-wish').innerText = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„";
    }

    // --- ãƒšãƒ¼ã‚¸ãƒ»ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    async function navTo(id) {
        await stopScanner();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        if (id === 'page-scan') {
            await startScanner('books');
        } else if (id === 'page-wishlist') {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'tab-scan-wish') await startScanner('wishlist');
        } else if (id === 'page-history') {
            handleSearch();
        }
        updateUI();
    }

    async function switchTab(id) {
        document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');

        if (id === 'tab-scan-wish') {
            await startScanner('wishlist');
        } else {
            await stopScanner();
        }
    }

    // --- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆï¼šãƒãƒƒãƒˆæ¤œç´¢ ---
    async function searchWish() {
        const query = document.getElementById('wishSearchInput').value.trim();
        const target = document.getElementById('wishCandidates');
        if(!query) return;
        target.style.display = "block"; target.innerHTML = "<p style='padding:10px;text-align:center;'>æ¤œç´¢ä¸­...</p>";
        try {
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=15`);
            const data = await res.json();
            if(!data.items || data.items.length === 0) { 
                target.innerHTML = "<p style='padding:10px;text-align:center;'>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>"; return; 
            }
            tempSearchList = data.items.map(item => {
                const i = item.volumeInfo;
                const links = i.imageLinks || {};
                const thumb = (links.thumbnail || links.smallThumbnail || "").replace('http:', 'https:');
                return {
                    title: i.title || "ä¸æ˜", author: i.authors ? i.authors.join(', ') : "ä¸æ˜", publisher: i.publisher || "",
                    thumbnail: thumb, isbn: i.industryIdentifiers ? i.industryIdentifiers[0].identifier : ""
                };
            });
            target.innerHTML = tempSearchList.map((b, idx) => `
                <div class="list-item">
                    <img src="${b.thumbnail || NO_IMAGE}" class="book-thumb" onerror="this.src='${NO_IMAGE}'">
                    <div class="item-info"><strong>${escapeHtml(b.title)}</strong><br><small>${escapeHtml(b.author)}</small></div>
                    <button class="btn btn-wish btn-small" onclick="addWishFromSearch(${idx})">è¿½åŠ </button>
                </div>`).join('');
        } catch(e) { target.innerHTML = "<p style='padding:10px;color:red;text-align:center;'>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>"; }
    }

    function addWishFromSearch(idx) {
        const b = tempSearchList[idx];
        wishlist.push({...b, date:"æœªè³¼å…¥", rating:0, impression:"", status:"æœªèª­", readDate:""});
        saveData(); alert("è¿½åŠ ã—ã¾ã—ãŸ");
    }

    function addManual() {
        const title = document.getElementById('manualTitle').value.trim();
        const author = document.getElementById('manualAuthor').value.trim();
        const publisher = document.getElementById('manualPublisher').value.trim();
        if(!title) { alert("é¡Œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        wishlist.push({ title, author, publisher, thumbnail: "", isbn: "", date:"æœªè³¼å…¥", rating:0, impression:"", status:"æœªèª­", readDate:"" });
        saveData();
        document.getElementById('manualTitle').value = ""; document.getElementById('manualAuthor').value = ""; document.getElementById('manualPublisher').value = "";
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
    }

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã¨ä¸€è¦§è¡¨ç¤º ---
    function saveData() { localStorage.setItem('myBooks', JSON.stringify(books)); localStorage.setItem('myWishlist', JSON.stringify(wishlist)); updateUI(); }

    function updateUI() {
        document.getElementById('current-count').innerText = books.length;
        document.getElementById('wish-count').innerText = wishlist.length;
        
        const wishUI = document.getElementById('wishListUI');
        wishUI.innerHTML = wishlist.length === 0 ? "<p style='text-align:center;color:#999;padding:20px;'>ç©ºã§ã™</p>" : 
            wishlist.map((b, i) => `
                <div class="list-item">
                    <img src="${b.thumbnail || NO_IMAGE}" class="book-thumb" onerror="this.src='${NO_IMAGE}'">
                    <div class="item-info"><strong>${escapeHtml(b.title)}</strong><br><small>${escapeHtml(b.author)}</small></div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-primary btn-small" onclick="purchaseBook(${i})">è³¼å…¥</button>
                        <button class="btn btn-outline btn-small" onclick="openEdit(${i}, 'wish')">è©³ç´°</button>
                    </div>
                </div>`).reverse().join('');
        
        if (document.getElementById('page-history').classList.contains('active')) handleSearch();
    }

    function purchaseBook(i) {
        const b = wishlist[i]; b.date = new Date().toLocaleDateString('ja-JP'); b.status = "æœªèª­";
        books.push(b); wishlist.splice(i, 1); saveData(); alert("è”µæ›¸ã«ç§»å‹•ã—ã¾ã—ãŸ");
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase().trim();
        const filtered = books.map((b, i) => ({...b, originalIndex: i}))
                              .filter(b => (b.title + b.author + (b.publisher||"") + (b.impression||"")).toLowerCase().includes(term));
        
        const ui = document.getElementById('historyListUI');
        ui.innerHTML = filtered.length === 0 ? "<p style='text-align:center;color:#999;padding:20px;'>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>" : 
            filtered.map(b => `
                <div class="list-item">
                    <img src="${b.thumbnail || NO_IMAGE}" class="book-thumb" onerror="this.src='${NO_IMAGE}'">
                    <div class="item-info">
                        <span class="item-title">${escapeHtml(b.title)}</span>
                        <span class="status-badge ${b.status === 'èª­äº†' ? 'status-read' : ''}">${b.status || 'æœªèª­'}</span>
                        <span style="color:var(--accent); font-size:0.75rem;">${"â˜…".repeat(b.rating || 0)}</span>
                        <div style="font-size:0.7rem; color:#64748b; margin-top:2px;">${escapeHtml(b.author)}</div>
                    </div>
                    <button class="btn btn-outline btn-small" onclick="openEdit(${b.originalIndex}, 'books')">è©³ç´°</button>
                </div>`).reverse().join('');
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
    function openEdit(idx, mode) {
        const b = (mode === 'books') ? books[idx] : wishlist[idx];
        if(!b) return;
        document.getElementById('edit-index').value = idx;
        document.getElementById('edit-mode').value = mode;
        document.getElementById('editThumb').src = b.thumbnail || NO_IMAGE;
        document.getElementById('edit-title').value = b.title || "";
        document.getElementById('edit-author').value = b.author || "";
        document.getElementById('edit-publisher').value = b.publisher || "";
        document.getElementById('edit-status').value = b.status || "æœªèª­";
        document.getElementById('edit-read-date').value = b.readDate || "";
        document.getElementById('edit-impression').value = b.impression || "";
        setRatingUI(b.rating || 0);
        document.getElementById('editModal').style.display = "flex";
    }

    function saveEdit() {
        const idx = document.getElementById('edit-index').value;
        const mode = document.getElementById('edit-mode').value;
        const target = (mode === 'books') ? books[idx] : wishlist[idx];
        target.title = document.getElementById('edit-title').value;
        target.author = document.getElementById('edit-author').value;
        target.publisher = document.getElementById('edit-publisher').value;
        target.status = document.getElementById('edit-status').value;
        target.readDate = document.getElementById('edit-read-date').value;
        target.impression = document.getElementById('edit-impression').value;
        target.rating = parseInt(document.getElementById('edit-rating-val').value);
        saveData(); closeModal();
    }

    function deleteEntry() {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            const idx = document.getElementById('edit-index').value;
            const mode = document.getElementById('edit-mode').value;
            if(mode === 'books') books.splice(idx,1); else wishlist.splice(idx,1);
            saveData(); closeModal();
        }
    }

    function initRatingEvents() { document.querySelectorAll('#ratingEdit span').forEach(star => { star.onclick = function() { setRatingUI(this.getAttribute('data-v')); }; }); }
    function setRatingUI(val) { document.getElementById('edit-rating-val').value = val; document.querySelectorAll('#ratingEdit span').forEach(s => s.classList.toggle('selected', s.getAttribute('data-v') <= val)); }
    function closeModal() { document.getElementById('editModal').style.display = "none"; }
    function escapeHtml(s) { return s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ""; }
    function exportToFile() { const blob = new Blob([JSON.stringify({books, wishlist}, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'library_data.json'; a.click(); }
</script>
</body>
</html>
