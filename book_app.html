<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.14</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --accent: #f59e0b; --wish: #10b981; --amazon: #ff9900; }
        body { font-family: sans-serif; margin: 0; background-color: var(--bg); color: #334155; line-height: 1.6; }
        .nav-header { background: var(--primary); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .container { max-width: 800px; margin: auto; padding: 15px; }
        .page { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center; transition: 0.2s; border: 1px solid transparent; }
        .btn-full { display: block; width: 100%; margin: 8px 0; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-wish { background: var(--wish); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; }
        .btn-small { padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; }

        .text-input, .select-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; background: white; }
        
        /* ä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .list-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; gap: 12px; position: relative; }
        .book-thumb { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; background: #e2e8f0; flex-shrink: 0; }
        .item-info { flex: 1; font-size: 0.85rem; }
        .item-title { font-weight: bold; display: block; margin-bottom: 2px; }
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: #e2e8f0; color: #475569; }
        .status-read { background: #dcfce7; color: #166534; }
        
        /* ã‚¹ã‚­ãƒ£ãƒ³ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        #confirmModal, #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        .modal-thumb-large { width: 120px; height: 170px; object-fit: cover; display: block; margin: 0 auto 15px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-label { font-size: 0.8rem; font-weight: bold; color: #64748b; display: block; margin-top: 10px; }
        
        .rating-stars span { cursor: pointer; font-size: 1.5rem; color: #cbd5e1; }
        .rating-stars span.selected { color: var(--accent); }
    </style>
</head>
<body>

<div class="nav-header">è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.14</div>

<div class="container">
    <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
    <section id="page-top" class="page active">
        <div class="card" style="text-align: center;">
            <button class="btn btn-primary btn-full" onclick="navTo('page-scan')">ğŸ“¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
            <button class="btn btn-wish btn-full" onclick="navTo('page-wishlist')">ğŸŒŸ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
            <button class="btn btn-outline btn-full" onclick="navTo('page-history')">ğŸ“‚ è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</button>
        </div>
        <div class="card">
            <p>è”µæ›¸æ•°: <strong><span id="current-count">0</span></strong> / ã‚¦ã‚£ãƒƒã‚·ãƒ¥: <strong><span id="wish-count">0</span></strong></p>
        </div>
    </section>

    <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ -->
    <section id="page-scan" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card">
            <div id="reader"></div>
            <div id="scan-status" style="margin-top:10px; font-weight:bold; color:var(--primary); text-align:center;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«å…¥ã‚Œã¦ãã ã•ã„</div>
        </div>
    </section>

    <!-- è”µæ›¸ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
    <section id="page-history" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div class="card">
            <input type="text" id="searchInput" class="text-input" placeholder="è”µæ›¸ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ»æ„Ÿæƒ³ã‹ã‚‰æ¤œç´¢..." oninput="handleSearch()">
            <div id="historyListUI" style="margin-top:10px;"></div>
        </div>
        <button class="btn btn-outline btn-full" onclick="exportToFile()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜(JSON)</button>
    </section>

    <!-- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆç­‰ã®ä»–ãƒšãƒ¼ã‚¸ã¯å‰Verã¨åŒæ§˜ã®ãŸã‚çœç•¥ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã¯ä¿æŒ -->
    <section id="page-wishlist" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')" style="margin-bottom:10px;">â† æˆ»ã‚‹</button>
        <div id="wishListUI"></div>
    </section>
</div>

<!-- ã‚¹ã‚­ãƒ£ãƒ³ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="confirmModal">
    <div class="modal-content">
        <img id="confirmThumb" class="modal-thumb-large" src="" alt="">
        <h3 id="confirmTitle" style="text-align:center; margin:0 0 5px;"></h3>
        <p id="confirmAuthor" style="text-align:center; color:#64748b; margin-bottom:20px;"></p>
        <p style="text-align:center; font-weight:bold; color:var(--primary);">ã“ã®æœ¬ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:2;" onclick="confirmRegister()">ç™»éŒ²ã™ã‚‹</button>
            <button class="btn btn-secondary" style="flex:1;" onclick="cancelRegister()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<!-- è©³ç´°ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal">
    <div class="modal-content">
        <img id="editThumb" class="modal-thumb-large" src="" alt="">
        <div class="rating-stars" id="ratingEdit" style="text-align:center; margin-bottom:10px;">
            <span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span><span data-v="4">â˜…</span><span data-v="5">â˜…</span>
        </div>
        <input type="hidden" id="edit-index"><input type="hidden" id="edit-mode">
        
        <label class="modal-label">èª­æ›¸çŠ¶æ³</label>
        <select id="edit-status" class="select-input">
            <option value="æœªèª­">æœªèª­</option>
            <option value="èª­æ›¸ä¸­">èª­æ›¸ä¸­</option>
            <option value="èª­äº†">èª­äº†</option>
        </select>

        <label class="modal-label">èª­äº†æ—¥</label>
        <input type="date" id="edit-read-date" class="text-input">

        <label class="modal-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼ / ã‚¿ã‚°</label>
        <input type="text" id="edit-category" class="text-input" placeholder="ä¾‹ï¼šå°èª¬, æŠ€è¡“æ›¸, æ–™ç†">

        <label class="modal-label">é¡Œå</label>
        <input type="text" id="edit-title" class="text-input">

        <label class="modal-label">ä½œè€…</label>
        <input type="text" id="edit-author" class="text-input">

        <label class="modal-label">è³¼å…¥ä¾¡æ ¼ (å††)</label>
        <input type="number" id="edit-price" class="text-input" placeholder="0">

        <label class="modal-label">æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢</label>
        <textarea id="edit-impression" class="text-input" style="height:80px;"></textarea>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-primary" style="flex:2;" onclick="saveEdit()">ä¿å­˜</button>
            <button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">æˆ»ã‚‹</button>
        </div>
        <button class="btn btn-full" style="color:red; background:none; font-size:0.8rem;" onclick="deleteEntry()">å‰Šé™¤</button>
    </div>
</div>

<script>
    let books = JSON.parse(localStorage.getItem('myBooks') || '[]');
    let wishlist = JSON.parse(localStorage.getItem('myWishlist') || '[]');
    let html5QrCode = null;
    let pendingBook = null; // ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ç¢ºèªå¾…ã¡ã®æœ¬

    window.onload = () => {
        initRatingEvents();
        updateUI();
    };

    // --- ã‚¹ã‚­ãƒ£ãƒ³ç®¡ç† ---
    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (isbn) => {
            if (isbn.startsWith("978")) {
                html5QrCode.pause(); // ã‚¹ã‚­ãƒ£ãƒ³ã‚’ä¸€æ™‚åœæ­¢
                fetchBookInfoForConfirm(isbn);
            }
        }).catch(err => { document.getElementById('scan-status').innerText = "ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"; });
    }

    async function fetchBookInfoForConfirm(isbn) {
        document.getElementById('scan-status').innerText = "æ›¸ç±æƒ…å ±ã‚’ç…§åˆä¸­...";
        try {
            const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
            const data = await res.json();
            let title="", author="", publisher="", thumbnail="";

            if (data && data[0]) {
                const info = data[0].summary;
                title = info.title; author = info.author; publisher = info.publisher; thumbnail = info.cover || "";
            }
            if (!title) {
                const gRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
                const gData = await gRes.json();
                if (gData.items) {
                    const gInfo = gData.items[0].volumeInfo;
                    title = gInfo.title; author = gInfo.authors?.join(',');
                    thumbnail = gInfo.imageLinks?.thumbnail.replace('http:','https:');
                }
            }

            if (title) {
                pendingBook = { title, author, publisher, isbn, thumbnail, date: new Date().toLocaleDateString('ja-JP'), rating:0, impression:"", status:"æœªèª­", readDate:"", category:"", price:0 };
                showConfirmModal(pendingBook);
            } else {
                alert("æ›¸ç±æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                html5QrCode.resume();
            }
        } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); html5QrCode.resume(); }
    }

    function showConfirmModal(book) {
        document.getElementById('confirmThumb').src = book.thumbnail || "";
        document.getElementById('confirmTitle').innerText = book.title;
        document.getElementById('confirmAuthor').innerText = book.author;
        document.getElementById('confirmModal').style.display = "flex";
    }

    function confirmRegister() {
        if (books.some(b => b.isbn === pendingBook.isbn)) {
            alert("æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™");
        } else {
            books.push(pendingBook);
            saveData();
        }
        cancelRegister(); // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã¦å†é–‹
    }

    function cancelRegister() {
        document.getElementById('confirmModal').style.display = "none";
        pendingBook = null;
        document.getElementById('scan-status').innerText = "ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­...";
        if (html5QrCode) html5QrCode.resume();
    }

    // --- è©³ç´°ç·¨é›† ---
    function openEdit(index, mode) {
        const b = (mode === 'books') ? books[index] : wishlist[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('edit-mode').value = mode;
        document.getElementById('editThumb').src = b.thumbnail || "";
        document.getElementById('edit-title').value = b.title;
        document.getElementById('edit-author').value = b.author;
        document.getElementById('edit-status').value = b.status || "æœªèª­";
        document.getElementById('edit-read-date').value = b.readDate || "";
        document.getElementById('edit-category').value = b.category || "";
        document.getElementById('edit-price').value = b.price || 0;
        document.getElementById('edit-impression').value = b.impression || "";
        setRatingUI(b.rating || 0);
        document.getElementById('editModal').style.display = "flex";
    }

    function saveEdit() {
        const idx = document.getElementById('edit-index').value;
        const mode = document.getElementById('edit-mode').value;
        const target = (mode === 'books') ? books[idx] : wishlist[idx];
        
        target.title = document.getElementById('edit-title').value;
        target.author = document.getElementById('edit-author').value;
        target.status = document.getElementById('edit-status').value;
        target.readDate = document.getElementById('edit-read-date').value;
        target.category = document.getElementById('edit-category').value;
        target.price = document.getElementById('edit-price').value;
        target.impression = document.getElementById('edit-impression').value;
        target.rating = parseInt(document.querySelector('#ratingEdit input')?.value || target.rating);
        
        saveData();
        closeModal();
    }

    // --- UIæ›´æ–°ãƒ»ä¸€è¦§è¡¨ç¤º ---
    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = books.filter(b => (b.title + b.author + (b.category||"") + (b.impression||"")).toLowerCase().includes(term));
        document.getElementById('historyListUI').innerHTML = filtered.map((b) => {
            const idx = books.indexOf(b);
            const statusClass = b.status === "èª­äº†" ? "status-read" : "";
            return `<div class="list-item">
                <img src="${b.thumbnail || ''}" class="book-thumb">
                <div class="item-info">
                    <span class="item-title">${b.title}</span>
                    <span class="status-badge ${statusClass}">${b.status || 'æœªèª­'}</span>
                    <span style="color:var(--accent); font-size:0.75rem;">${"â˜…".repeat(b.rating || 0)}</span>
                    <div style="font-size:0.7rem; color:#64748b;">${b.author} ${b.category ? ' | ' + b.category : ''}</div>
                </div>
                <button class="btn btn-outline btn-small" onclick="openEdit(${idx}, 'books')">è©³ç´°</button>
            </div>`;
        }).reverse().join('');
    }

    function updateUI() {
        document.getElementById('current-count').innerText = books.length;
        document.getElementById('wish-count').innerText = wishlist.length;
        if (document.getElementById('page-history').classList.contains('active')) handleSearch();
    }

    function navTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if (html5QrCode) { try { html5QrCode.stop(); html5QrCode = null; } catch(e){} }
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'page-scan') startScanner();
        updateUI();
    }

    function saveData() { localStorage.setItem('myBooks', JSON.stringify(books)); localStorage.setItem('myWishlist', JSON.stringify(wishlist)); updateUI(); }
    function closeModal() { document.getElementById('editModal').style.display = "none"; }
    function initRatingEvents() {
        document.querySelectorAll('#ratingEdit span').forEach(star => {
            star.onclick = function() {
                const val = this.getAttribute('data-v');
                const parent = this.parentNode;
                let hiddenInput = parent.querySelector('input');
                if(!hiddenInput) { hiddenInput = document.createElement('input'); hiddenInput.type="hidden"; parent.appendChild(hiddenInput); }
                hiddenInput.value = val;
                parent.querySelectorAll('span').forEach(s => s.classList.toggle('selected', s.getAttribute('data-v') <= val));
            };
        });
    }
    function setRatingUI(val) {
        const parent = document.getElementById('ratingEdit');
        parent.querySelectorAll('span').forEach(s => s.classList.toggle('selected', s.getAttribute('data-v') <= val));
        let hiddenInput = parent.querySelector('input');
        if(!hiddenInput) { hiddenInput = document.createElement('input'); hiddenInput.type="hidden"; parent.appendChild(hiddenInput); }
        hiddenInput.value = val;
    }
    function deleteEntry() { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { const idx = document.getElementById('edit-index').value; if(document.getElementById('edit-mode').value === 'books') books.splice(idx,1); else wishlist.splice(idx,1); saveData(); closeModal(); } }
    function exportToFile() { const blob = new Blob([JSON.stringify({books, wishlist}, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'library_data_v14.json'; a.click(); }
</script>
</body>
</html>
