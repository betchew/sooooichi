<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.7</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --accent: #f59e0b; --wish: #10b981; }
        body { font-family: sans-serif; margin: 0; background-color: var(--bg); color: #334155; line-height: 1.6; }
        .nav-header { background: var(--primary); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .container { max-width: 800px; margin: auto; padding: 15px; }
        
        .page { display: none; }
        .active { display: block; }

        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-full { display: block; width: 100%; margin: 8px 0; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: white; }
        .btn-wish { background: var(--wish); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.75rem; border-radius: 4px; }

        .text-input, .textarea-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
        .textarea-input { height: 100px; resize: vertical; }

        /* ã‚¹ã‚¿ãƒ¼è©•ä¾¡ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .rating-select { display: flex; gap: 10px; margin-bottom: 15px; font-size: 1.5rem; color: #cbd5e1; }
        .rating-select span { cursor: pointer; }
        .rating-select span.selected { color: var(--accent); }
        .star-rating { color: var(--accent); font-weight: bold; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { border-bottom: 1px solid #e2e8f0; padding: 12px 5px; text-align: left; }
        th { background-color: #f1f5f9; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ”¹å–„ */
        #editModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content { 
            background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; 
            max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-label { display: block; font-size: 0.8rem; font-weight: bold; color: #64748b; margin-top: 10px; }
    </style>
</head>
<body>

<div class="nav-header">èª­æ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>

<div class="container">
    
    <!-- 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
    <section id="page-top" class="page active">
        <div class="card" style="text-align: center;">
            <h2>ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
            <button class="btn btn-primary btn-full" onclick="navTo('page-scan')">ğŸ“¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
            <button class="btn btn-wish btn-full" onclick="navTo('page-wishlist')">ğŸŒŸ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
            <button class="btn btn-outline btn-full" onclick="navTo('page-history')">ğŸ“‚ è”µæ›¸ä¸€è¦§ãƒ»æ„Ÿæƒ³ãƒ»æ¤œç´¢</button>
        </div>
        <div class="card">
            <p>ç¾åœ¨ã®è”µæ›¸æ•°: <strong><span id="current-count">0</span> å†Š</strong></p>
        </div>
    </section>

    <!-- 2. ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ -->
    <section id="page-scan" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <div id="reader" style="border-radius:12px;"></div>
            <div id="scan-status" style="margin-top:10px; color:var(--primary); font-weight:bold;">ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­...</div>
        </div>
        <div id="quickScanList"></div>
    </section>

    <!-- 3. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ -->
    <section id="page-wishlist" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <h3>æœ¬ã‚’æ¢ã™ / æ‰‹æ›¸ãè¿½åŠ </h3>
            <input type="text" id="wishSearchInput" class="text-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="searchWishCandidates()">ãƒãƒƒãƒˆæ¤œç´¢</button>
                <button class="btn btn-outline" onclick="addManualWish()">æ‰‹æ›¸ãã§å³ç™»éŒ²</button>
            </div>
            <div id="wishCandidates" style="margin-top:10px;"></div>
        </div>
        <div class="card">
            <h3>è²·ã„ãŸã„æœ¬ãƒªã‚¹ãƒˆ</h3>
            <div id="wishListUI"></div>
        </div>
    </section>

    <!-- 4. è”µæ›¸ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
    <section id="page-history" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <input type="text" id="searchInput" class="text-input" placeholder="é¡Œåãƒ»ä½œè€…ãƒ»æ„Ÿæƒ³ã‹ã‚‰æ¤œç´¢..." oninput="handleSearch()">
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>è©•ä¾¡</th><th>é¡Œå / ä½œè€…</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="historyList"></tbody>
                </table>
            </div>
        </div>
        <button class="btn btn-outline btn-full" onclick="exportToFile()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
        <div class="card">
            <input type="file" id="fileInput" accept=".json">
        </div>
    </section>
</div>

<!-- è©³ç´°ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal">
    <div class="modal-content">
        <h3 id="modalHead">æœ¬ã®è©³ç´°è¨­å®š</h3>
        <input type="hidden" id="edit-index">
        <input type="hidden" id="edit-mode">

        <label class="modal-label">è©•ä¾¡</label>
        <div class="rating-select" id="ratingSelect">
            <span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span><span data-v="4">â˜…</span><span data-v="5">â˜…</span>
        </div>
        <input type="hidden" id="edit-rating" value="0">

        <label class="modal-label">é¡Œå</label>
        <input type="text" id="edit-title" class="text-input">

        <label class="modal-label">ä½œè€…</label>
        <input type="text" id="edit-author" class="text-input">

        <label class="modal-label">èª­äº†æ—¥ï¼ˆèª­ã¿çµ‚ã‚ã£ãŸæ—¥ï¼‰</label>
        <input type="date" id="edit-read-date" class="text-input">

        <label class="modal-label">èª­æ›¸æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢</label>
        <textarea id="edit-impression" class="textarea-input" placeholder="æ„Ÿæƒ³ã‚’è‡ªç”±ã«æ›¸ãè¾¼ã‚ã¾ã™"></textarea>

        <label class="modal-label">å‡ºç‰ˆç¤¾</label>
        <input type="text" id="edit-publisher" class="text-input">

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" style="flex: 2;" onclick="saveEdit()">å¤‰æ›´ã‚’ä¿å­˜</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <button class="btn btn-full" style="color:#ef4444; background:none; margin-top:15px; font-size:0.8rem;" onclick="deleteEntry()">ã“ã®æœ¬ã‚’å‰Šé™¤ã™ã‚‹</button>
    </div>
</div>

<script>
    let html5QrCode = null;
    let books = [];
    let wishlist = [];
    let currentSearchTerm = "";

    window.onload = () => {
        books = JSON.parse(localStorage.getItem('myBooks') || '[]');
        wishlist = JSON.parse(localStorage.getItem('myWishlist') || '[]');
        initRatingEvents();
        updateUI();
    };

    function initRatingEvents() {
        document.querySelectorAll('#ratingSelect span').forEach(star => {
            star.onclick = function() {
                const val = this.getAttribute('data-v');
                setRatingUI(val);
            };
        });
    }

    function setRatingUI(val) {
        document.getElementById('edit-rating').value = val;
        document.querySelectorAll('#ratingSelect span').forEach(s => {
            s.classList.toggle('selected', s.getAttribute('data-v') <= val);
        });
    }

    async function navTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if (html5QrCode) { try { await html5QrCode.stop(); html5QrCode = null; } catch (e) {} }
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'page-scan') startScanner();
        updateUI();
    }

    // --- ã‚¹ã‚­ãƒ£ãƒ³ ---
    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, (isbn) => {
            if (isbn.startsWith("978")) handleScanSuccess(isbn);
        }).catch(err => { console.log(err); });
    }

    async function handleScanSuccess(isbn) {
        if (books.some(b => b.isbn === isbn)) return;
        document.getElementById('scan-status').innerText = "å–å¾—ä¸­...";
        try {
            const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
            const data = await res.json();
            if (data && data[0]) {
                const info = data[0].summary;
                books.push({ 
                    title: info.title, author: info.author, publisher: info.publisher, 
                    date: new Date().toLocaleDateString('ja-JP'), isbn: isbn,
                    rating: 0, impression: "", readDate: "" 
                });
                saveData();
                document.getElementById('scan-status').innerText = "âœ… " + info.title;
            }
        } catch (e) {}
    }

    // --- ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆæ¤œç´¢ ---
    async function searchWishCandidates() {
        const query = document.getElementById('wishSearchInput').value;
        if (!query) return;
        const target = document.getElementById('wishCandidates');
        target.innerHTML = "æ¤œç´¢ä¸­...";
        try {
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
            const data = await res.json();
            if (!data.items) { target.innerHTML = "ãªã—"; return; }
            target.innerHTML = data.items.map(item => {
                const info = item.volumeInfo;
                const book = { title: info.title, author: info.authors ? info.authors[0] : 'ä¸æ˜', publisher: info.publisher || '', isbn: '' };
                return `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:0.8rem;"><strong>${info.title}</strong><br>${book.author}</div>
                    <button class="btn btn-wish btn-small" onclick='addBookToWish(${JSON.stringify(book).replace(/'/g, "&apos;")})'>è¿½åŠ </button>
                </div>`;
            }).join('');
        } catch (e) { target.innerHTML = "ã‚¨ãƒ©ãƒ¼"; }
    }

    function addBookToWish(book) {
        wishlist.push({ ...book, rating: 0, impression: "", readDate: "" });
        saveData();
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
    }

    function addManualWish() {
        const title = document.getElementById('wishSearchInput').value || "ç„¡é¡Œã®æœ¬";
        wishlist.push({ title, author: "", publisher: "", rating: 0, impression: "", readDate: "" });
        saveData();
        alert("ç™»éŒ²ã—ã¾ã—ãŸ");
    }

    // --- UIæç”» ---
    function updateUI() {
        document.getElementById('current-count').innerText = books.length;
        renderHistoryTable();
        renderWishTable();
    }

    function renderHistoryTable() {
        const target = document.getElementById('historyList');
        const filtered = books.filter(b => (b.title + b.author + (b.impression || "")).toLowerCase().includes(currentSearchTerm));
        
        target.innerHTML = filtered.map((b) => {
            const idx = books.indexOf(b);
            const stars = "â˜…".repeat(b.rating || 0).padEnd(5, "â˜†");
            const hasMemo = b.impression ? "ğŸ“" : "";
            return `<tr>
                <td class="star-rating">${stars}</td>
                <td><strong>${b.title}</strong><br><small>${b.author}</small></td>
                <td>${hasMemo}</td>
                <td><button class="btn btn-primary btn-small" onclick="openEdit(${idx}, 'books')">è©³ç´°</button></td>
            </tr>`;
        }).reverse().join('');
    }

    function renderWishTable() {
        document.getElementById('wishListUI').innerHTML = wishlist.map((b, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <div style="font-size:0.85rem;"><strong>${b.title}</strong><br>${b.author}</div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-primary btn-small" onclick="moveToLibrary(${i})">è³¼å…¥æ¸ˆ</button>
                    <button class="btn btn-secondary btn-small" onclick="openEdit(${i}, 'wish')">ç·¨é›†</button>
                </div>
            </div>
        `).reverse().join('');
    }

    function openEdit(index, mode) {
        const b = mode === 'books' ? books[index] : wishlist[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('edit-mode').value = mode;
        document.getElementById('edit-title').value = b.title;
        document.getElementById('edit-author').value = b.author;
        document.getElementById('edit-publisher').value = b.publisher || '';
        document.getElementById('edit-impression').value = b.impression || '';
        document.getElementById('edit-read-date').value = b.readDate || '';
        setRatingUI(b.rating || 0);
        document.getElementById('editModal').style.display = 'flex';
    }

    function saveEdit() {
        const index = document.getElementById('edit-index').value;
        const mode = document.getElementById('edit-mode').value;
        const target = mode === 'books' ? books[index] : wishlist[index];
        
        target.title = document.getElementById('edit-title').value;
        target.author = document.getElementById('edit-author').value;
        target.publisher = document.getElementById('edit-publisher').value;
        target.impression = document.getElementById('edit-impression').value;
        target.readDate = document.getElementById('edit-read-date').value;
        target.rating = parseInt(document.getElementById('edit-rating').value);
        
        saveData();
        closeModal();
    }

    function deleteEntry() {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const index = document.getElementById('edit-index').value;
        if(document.getElementById('edit-mode').value === 'books') books.splice(index, 1);
        else wishlist.splice(index, 1);
        saveData();
        closeModal();
    }

    function moveToLibrary(i) {
        const b = wishlist[i];
        b.readDate = new Date().toISOString().split('T')[0];
        books.push(b);
        wishlist.splice(i, 1);
        saveData();
    }

    function handleSearch() {
        currentSearchTerm = document.getElementById('searchInput').value.toLowerCase();
        renderHistoryTable();
    }

    function saveData() {
        localStorage.setItem('myBooks', JSON.stringify(books));
        localStorage.setItem('myWishlist', JSON.stringify(wishlist));
        updateUI();
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }
    function navToTop() { navTo('page-top'); }
    function exportToFile() {
        const blob = new Blob([JSON.stringify({books, wishlist}, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'my_books_full.json'; a.click();
    }
</script>
</body>
</html>
