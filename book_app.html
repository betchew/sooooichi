<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.9</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --accent: #f59e0b; --wish: #10b981; --amazon: #ff9900; }
        body { font-family: sans-serif; margin: 0; background-color: var(--bg); color: #334155; line-height: 1.6; }
        .nav-header { background: var(--primary); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .container { max-width: 800px; margin: auto; padding: 15px; }
        .page { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center; transition: 0.2s; }
        .btn-full { display: block; width: 100%; margin: 8px 0; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-wish { background: var(--wish); color: white; }
        .btn-amazon { background: var(--amazon); color: white; font-weight: bold; }
        .btn-secondary { background: #64748b; color: white; }
        .text-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
        .hint { font-size: 0.75rem; color: #64748b; margin-top: -5px; margin-bottom: 10px; }
        
        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .item-info { flex: 1; font-size: 0.85rem; }
        .item-title { font-weight: bold; display: block; }
    </style>
</head>
<body>

<div class="nav-header">è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.9</div>

<div class="container">
    <!-- 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
    <section id="page-top" class="page active">
        <div class="card" style="text-align: center;">
            <button class="btn btn-primary btn-full" onclick="navTo('page-scan')">ğŸ“¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
            <button class="btn btn-wish btn-full" onclick="navTo('page-wishlist')">ğŸŒŸ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
            <button class="btn btn-outline btn-full" style="border:1px solid #ccc;" onclick="navTo('page-history')">ğŸ“‚ è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</button>
        </div>
        <div class="card">
            <p>è”µæ›¸æ•°: <strong><span id="current-count">0</span></strong> / ã‚¦ã‚£ãƒƒã‚·ãƒ¥: <strong><span id="wish-count">0</span></strong></p>
        </div>
    </section>

    <!-- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ -->
    <section id="page-wishlist" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        
        <!-- Amazon URLç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card" style="border-left: 5px solid var(--amazon);">
            <h3>Amazon URLã‹ã‚‰è¿½åŠ </h3>
            <p class="hint">å•†å“ã®URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨è‡ªå‹•ã§æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
            <input type="text" id="amazonUrlInput" class="text-input" placeholder="https://www.amazon.co.jp/dp/...">
            <button class="btn btn-amazon btn-full" onclick="addFromAmazonUrl()">URLã‹ã‚‰æ›¸ç±æƒ…å ±ã‚’å–å¾—</button>
            <div id="amazon-status" style="font-size:0.8rem; margin-top:5px;"></div>
        </div>

        <!-- ãƒãƒƒãƒˆæ¤œç´¢ç™»éŒ² -->
        <div class="card">
            <h3>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¢ã™</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="wishSearchInput" class="text-input" placeholder="é¡Œåã‚„ä½œè€…...">
                <button class="btn btn-primary" onclick="searchWishCandidates()">æ¤œç´¢</button>
            </div>
            <div id="wishCandidates" style="max-height: 200px; overflow-y: auto; border:1px solid #eee; border-radius:8px; display:none;"></div>
        </div>

        <div class="card">
            <h3>ç¾åœ¨ã®ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</h3>
            <div id="wishListUI"></div>
        </div>
    </section>

    <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ãƒ»ä¸€è¦§ãƒšãƒ¼ã‚¸ãªã©ã¯ä»¥å‰ã®Verã‚’ç¶™æ‰¿ï¼ˆçœç•¥ã›ãšã«å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã¯ä¿æŒï¼‰ -->
    <section id="page-scan" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card"><div id="reader"></div><div id="scan-status">æº–å‚™ä¸­...</div></div>
    </section>

    <section id="page-history" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <input type="text" id="searchInput" class="text-input" placeholder="æ¤œç´¢..." oninput="handleSearch()">
            <div id="historyListUI"></div>
        </div>
    </section>
</div>

<script>
    let books = JSON.parse(localStorage.getItem('myBooks') || '[]');
    let wishlist = JSON.parse(localStorage.getItem('myWishlist') || '[]');

    // --- Amazon URL è§£ææ©Ÿèƒ½ ---
    async function addFromAmazonUrl() {
        const urlInput = document.getElementById('amazonUrlInput');
        const statusEl = document.getElementById('amazon-status');
        const url = urlInput.value.trim();
        
        if (!url) return;
        statusEl.innerText = "URLã‚’è§£æä¸­...";

        // ASIN/ISBNã®æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ (dp/XXXXX ã¾ãŸã¯ product/XXXXX ã¾ãŸã¯ ASIN=XXXXX)
        // 10æ¡ã¾ãŸã¯13æ¡ã®è‹±æ•°å­—ã‚’æŠ½å‡º
        const regex = /\/(?:dp|product|ASIN)\/([A-Z0-9]{10,13})/i;
        const match = url.match(regex);

        if (match && match[1]) {
            const code = match[1];
            statusEl.innerText = `ã‚³ãƒ¼ãƒ‰æŠ½å‡ºæˆåŠŸ (${code})ã€‚æƒ…å ±å–å¾—ä¸­...`;
            
            // ã¾ãš openBD (ISBN) ã§è©¦è¡Œ
            try {
                const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${code}`);
                const data = await res.json();
                
                if (data && data[0]) {
                    const info = data[0].summary;
                    addToWishlist(info.title, info.author, info.publisher, info.isbn);
                    statusEl.style.color = "green";
                    statusEl.innerText = "âœ… ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼";
                    urlInput.value = "";
                } else {
                    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ Google Books API ã§è©¦è¡Œ
                    const gRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${code}`);
                    const gData = await gRes.json();
                    
                    if (gData.items && gData.items[0]) {
                        const info = gData.items[0].volumeInfo;
                        addToWishlist(info.title, info.authors?.join(','), info.publisher, code);
                        statusEl.style.color = "green";
                        statusEl.innerText = "âœ… ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼";
                        urlInput.value = "";
                    } else {
                        statusEl.style.color = "red";
                        statusEl.innerText = "âŒ æ›¸ç±æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                    }
                }
            } catch (e) {
                statusEl.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            }
        } else {
            statusEl.style.color = "red";
            statusEl.innerText = "âŒ æœ‰åŠ¹ãªå•†å“ã‚³ãƒ¼ãƒ‰ã‚’URLã‹ã‚‰è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
        }
    }

    function addToWishlist(title, author, publisher, isbn) {
        wishlist.push({
            title: title || "ä¸æ˜ãªã‚¿ã‚¤ãƒˆãƒ«",
            author: author || "ä¸æ˜ãªè‘—è€…",
            publisher: publisher || "",
            isbn: isbn || "",
            date: "æœªè³¼å…¥",
            rating: 0,
            impression: ""
        });
        saveData();
    }

    // --- ãƒšãƒ¼ã‚¸ç®¡ç†ãƒ»UIæ›´æ–° ---
    function navTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        updateUI();
    }

    function updateUI() {
        document.getElementById('current-count').innerText = books.length;
        document.getElementById('wish-count').innerText = wishlist.length;
        
        const wishUI = document.getElementById('wishListUI');
        wishUI.innerHTML = wishlist.map((b, i) => `
            <div class="list-item">
                <div class="item-info">
                    <span class="item-title">${b.title}</span>
                    <small>${b.author}</small>
                </div>
                <button class="btn btn-primary btn-small" onclick="moveToLibrary(${i})">è³¼å…¥</button>
            </div>
        `).reverse().join('');
    }

    function saveData() {
        localStorage.setItem('myBooks', JSON.stringify(books));
        localStorage.setItem('myWishlist', JSON.stringify(wishlist));
        updateUI();
    }

    function moveToLibrary(i) {
        const b = wishlist[i];
        b.date = new Date().toLocaleDateString('ja-JP');
        books.push(b);
        wishlist.splice(i, 1);
        saveData();
    }

    // ä»–ã®å…±é€šé–¢æ•°ï¼ˆsearchWishCandidatesç­‰ï¼‰ã¯ä»¥å‰ã®Verã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
</script>
</body>
</html>
