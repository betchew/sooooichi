<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.8 (ä¿®æ­£ç‰ˆ)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --accent: #f59e0b; --wish: #10b981; }
        body { font-family: sans-serif; margin: 0; background-color: var(--bg); color: #334155; line-height: 1.6; }
        .nav-header { background: var(--primary); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .container { max-width: 800px; margin: auto; padding: 15px; }
        .page { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center; transition: opacity 0.2s; }
        .btn-full { display: block; width: 100%; margin: 8px 0; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.75rem; border-radius: 4px; }
        .text-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #eee; min-height: 250px; }
        .error-msg { color: #ef4444; background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { border-bottom: 1px solid #e2e8f0; padding: 12px 5px; text-align: left; }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ã¯å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¶™æ‰¿ */
        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .rating-select span { cursor: pointer; font-size: 1.5rem; color: #cbd5e1; }
        .rating-select span.selected { color: var(--accent); }
    </style>
</head>
<body>

<div class="nav-header">è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>

<div class="container">
    <!-- HTTPSè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="secure-warning" class="error-msg">
        âš ï¸ <strong>ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</strong><br>
        ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã«ã‚ˆã‚Šã€ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯HTTPSç’°å¢ƒï¼ˆhttps://...ï¼‰ã§é–‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    </div>

    <!-- 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
    <section id="page-top" class="page active">
        <div class="card" style="text-align: center;">
            <button class="btn btn-primary btn-full" onclick="navTo('page-scan')">ğŸ“¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
            <button class="btn btn-wish btn-full" onclick="navTo('page-wishlist')">ğŸŒŸ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
            <button class="btn btn-outline btn-full" onclick="navTo('page-history')">ğŸ“‚ è”µæ›¸ä¸€è¦§ãƒ»æ„Ÿæƒ³ãƒ»æ¤œç´¢</button>
        </div>
        <div class="card">
            <p>è”µæ›¸æ•°: <strong><span id="current-count">0</span></strong> / ã‚¦ã‚£ãƒƒã‚·ãƒ¥: <strong><span id="wish-count">0</span></strong></p>
        </div>
    </section>

    <!-- 2. ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ -->
    <section id="page-scan" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <h3>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h3>
            <div id="reader"></div>
            <div id="scan-status" style="margin-top:10px; color:var(--primary); font-weight:bold;">ã‚«ãƒ¡ãƒ©æº–å‚™ä¸­...</div>
            <div id="camera-error" style="color:red; font-size:0.8rem; margin-top:5px;"></div>
        </div>

        <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šISBNæ‰‹å…¥åŠ› -->
        <div class="card">
            <h3>ISBNæ‰‹å…¥åŠ› (ã‚«ãƒ¡ãƒ©ãŒå‹•ã‹ãªã„å ´åˆ)</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="manualIsbn" class="text-input" placeholder="9784..." style="margin-bottom:0;">
                <button class="btn btn-primary" onclick="handleManualScan()">å–å¾—</button>
            </div>
        </div>
    </section>

    <!-- 3. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ -->
    <section id="page-wishlist" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <h3>æœ¬ã‚’æ¢ã™ / è¿½åŠ </h3>
            <input type="text" id="wishSearchInput" class="text-input" placeholder="é¡Œåã‚„ä½œè€…ã§æ¤œç´¢...">
            <button class="btn btn-primary btn-full" onclick="searchWishCandidates()">ãƒãƒƒãƒˆæ¤œç´¢</button>
            <div id="wishCandidates"></div>
        </div>
        <div class="card">
            <h3>ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</h3>
            <div id="wishListUI"></div>
        </div>
    </section>

    <!-- 4. è”µæ›¸ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
    <section id="page-history" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <input type="text" id="searchInput" class="text-input" placeholder="é¡Œåãƒ»ä½œè€…ãƒ»æ„Ÿæƒ³ã§æ¤œç´¢..." oninput="handleSearch()">
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>è©•ä¾¡</th><th>é¡Œå</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="historyList"></tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- è©³ç´°ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« (Ver.7ã¨åŒæ§˜) -->
<div id="editModal">
    <div class="modal-content">
        <h3 id="modalHead">æœ¬ã®è©³ç´°è¨­å®š</h3>
        <input type="hidden" id="edit-index">
        <input type="hidden" id="edit-mode">
        <div class="rating-select" id="ratingSelect">
            <span data-v="1">â˜…</span><span data-v="2">â˜…</span><span data-v="3">â˜…</span><span data-v="4">â˜…</span><span data-v="5">â˜…</span>
        </div>
        <input type="hidden" id="edit-rating" value="0">
        <input type="text" id="edit-title" class="text-input" placeholder="é¡Œå">
        <input type="text" id="edit-author" class="text-input" placeholder="ä½œè€…">
        <textarea id="edit-impression" class="text-input" style="height:100px;" placeholder="æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢"></textarea>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" style="flex: 2;" onclick="saveEdit()">ä¿å­˜</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<script>
    let html5QrCode = null;
    let books = [];
    let wishlist = [];

    window.onload = () => {
        // HTTPSãƒã‚§ãƒƒã‚¯
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            document.getElementById('secure-warning').style.display = 'block';
        }
        books = JSON.parse(localStorage.getItem('myBooks') || '[]');
        wishlist = JSON.parse(localStorage.getItem('myWishlist') || '[]');
        initRatingEvents();
        updateUI();
    };

    function initRatingEvents() {
        document.querySelectorAll('#ratingSelect span').forEach(star => {
            star.onclick = function() {
                const val = this.getAttribute('data-v');
                document.getElementById('edit-rating').value = val;
                document.querySelectorAll('#ratingSelect span').forEach(s => {
                    s.classList.toggle('selected', s.getAttribute('data-v') <= val);
                });
            };
        });
    }

    async function navTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if (html5QrCode) {
            try { await html5QrCode.stop(); html5QrCode = null; } catch (e) { console.error(e); }
        }
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'page-scan') setTimeout(startScanner, 300); // UIæç”»å¾…ã¡
        updateUI();
    }

    function startScanner() {
        const statusEl = document.getElementById('scan-status');
        const errorEl = document.getElementById('camera-error');
        statusEl.innerText = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­...";
        errorEl.innerText = "";

        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 150 } };

        html5QrCode.start({ facingMode: "environment" }, config, (isbn) => {
            if (isbn.startsWith("978")) {
                handleFetchBook(isbn);
                // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ã®ãŸã‚ä¸€æ—¦æ­¢ã‚ã‚‹
                html5QrCode.pause();
                setTimeout(() => html5QrCode.resume(), 3000);
            }
        }).catch(err => {
            statusEl.innerText = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ";
            errorEl.innerText = "ç†ç”±: " + err + "\n(HTTPSç’°å¢ƒã‹ã€ã‚«ãƒ¡ãƒ©è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„)";
        });
    }

    function handleManualScan() {
        const isbn = document.getElementById('manualIsbn').value.trim();
        if (isbn.startsWith("978")) handleFetchBook(isbn);
        else alert("ISBNã¯978ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    }

    async function handleFetchBook(isbn) {
        document.getElementById('scan-status').innerText = "æ›¸ç±æƒ…å ±å–å¾—ä¸­...";
        try {
            // æ˜ç¤ºçš„ã« https ã‚’æŒ‡å®š
            const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
            if (!res.ok) throw new Error("Network error");
            const data = await res.json();
            
            if (data && data[0]) {
                const info = data[0].summary;
                if (!books.some(b => b.isbn === info.isbn)) {
                    books.push({
                        title: info.title, author: info.author, publisher: info.publisher,
                        date: new Date().toLocaleDateString('ja-JP'), isbn: info.isbn,
                        rating: 0, impression: "", readDate: ""
                    });
                    saveData();
                    document.getElementById('scan-status').innerText = "âœ… ç™»éŒ²å®Œäº†: " + info.title;
                    alert("ç™»éŒ²ã—ã¾ã—ãŸ: " + info.title);
                } else {
                    document.getElementById('scan-status').innerText = "âš ï¸ æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™";
                }
            } else {
                document.getElementById('scan-status').innerText = "âŒ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            }
        } catch (e) {
            document.getElementById('scan-status').innerText = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            console.error(e);
        }
    }

    // --- ãã®ä»–UI/ä¿å­˜å‡¦ç† ---
    function updateUI() {
        document.getElementById('current-count').innerText = books.length;
        document.getElementById('wish-count').innerText = wishlist.length;
        renderHistory();
        renderWish();
    }

    function renderHistory() {
        const target = document.getElementById('historyList');
        target.innerHTML = books.map((b, i) => `<tr>
            <td>${"â˜…".repeat(b.rating).padEnd(5,"â˜†")}</td>
            <td><strong>${b.title}</strong><br><small>${b.author}</small></td>
            <td><button class="btn btn-primary btn-small" onclick="openEdit(${i}, 'books')">è©³ç´°</button></td>
        </tr>`).reverse().join('');
    }

    function renderWish() {
        document.getElementById('wishListUI').innerHTML = wishlist.map((b, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <div><strong>${b.title}</strong></div>
                <button class="btn btn-primary btn-small" onclick="moveToLibrary(${i})">è³¼å…¥</button>
            </div>`).join('');
    }

    function saveData() {
        localStorage.setItem('myBooks', JSON.stringify(books));
        localStorage.setItem('myWishlist', JSON.stringify(wishlist));
        updateUI();
    }

    // è©³ç´°ç·¨é›†ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ»ä¿å­˜ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒæ§˜ï¼‰
    function openEdit(index, mode) {
        const b = (mode === 'books') ? books[index] : wishlist[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('edit-mode').value = mode;
        document.getElementById('edit-title').value = b.title;
        document.getElementById('edit-author').value = b.author;
        document.getElementById('edit-impression').value = b.impression || "";
        // è©•ä¾¡ã®æ˜Ÿã‚’ã‚»ãƒƒãƒˆ
        const rating = b.rating || 0;
        document.getElementById('edit-rating').value = rating;
        document.querySelectorAll('#ratingSelect span').forEach(s => s.classList.toggle('selected', s.getAttribute('data-v') <= rating));
        document.getElementById('editModal').style.display = 'flex';
    }

    function saveEdit() {
        const idx = document.getElementById('edit-index').value;
        const mode = document.getElementById('edit-mode').value;
        const target = (mode === 'books') ? books[idx] : wishlist[idx];
        target.title = document.getElementById('edit-title').value;
        target.author = document.getElementById('edit-author').value;
        target.impression = document.getElementById('edit-impression').value;
        target.rating = parseInt(document.getElementById('edit-rating').value);
        saveData();
        closeModal();
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }
    function navTo(id) { /* æ—¢å­˜ã®navToã‚’ãã®ã¾ã¾ä½¿ç”¨ */ }
    // searchWishCandidates ãªã©ã®ä»–æ©Ÿèƒ½ã¯ Ver.7 ã‹ã‚‰ç¶™æ‰¿
</script>

</body>
</html>
