<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver.10</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --accent: #f59e0b; --wish: #10b981; --amazon: #ff9900; }
        body { font-family: sans-serif; margin: 0; background-color: var(--bg); color: #334155; line-height: 1.6; }
        .nav-header { background: var(--primary); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .container { max-width: 800px; margin: auto; padding: 15px; }
        .page { display: none; }
        .active { display: block; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center; transition: 0.2s; border: 1px solid transparent; }
        .btn-full { display: block; width: 100%; margin: 8px 0; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-wish { background: var(--wish); color: white; }
        .btn-amazon { background: var(--amazon); color: white; font-weight: bold; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #334155; }
        .text-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #eee; min-height: 250px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .item-info { flex: 1; font-size: 0.85rem; }
        .item-title { font-weight: bold; display: block; }
        .candidate-item { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="nav-header">è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>

<div class="container">
    <!-- 1. ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ -->
    <section id="page-top" class="page active">
        <div class="card" style="text-align: center;">
            <button class="btn btn-primary btn-full" onclick="navTo('page-scan')">ğŸ“¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
            <button class="btn btn-wish btn-full" onclick="navTo('page-wishlist')">ğŸŒŸ ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆ</button>
            <button class="btn btn-outline btn-full" onclick="navTo('page-history')">ğŸ“‚ è”µæ›¸ä¸€è¦§ãƒ»æ¤œç´¢</button>
        </div>
        <div class="card">
            <p>è”µæ›¸æ•°: <strong><span id="current-count">0</span></strong> / ã‚¦ã‚£ãƒƒã‚·ãƒ¥: <strong><span id="wish-count">0</span></strong></p>
        </div>
    </section>

    <!-- 2. ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ -->
    <section id="page-wishlist" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        
        <div class="card" style="border-left: 5px solid var(--amazon);">
            <h3>Amazon URLã‹ã‚‰è¿½åŠ </h3>
            <input type="text" id="amazonUrlInput" class="text-input" placeholder="Amazonã®URLã‚’è²¼ã‚Šä»˜ã‘">
            <button class="btn btn-amazon btn-full" onclick="addFromAmazonUrl()">URLã‹ã‚‰æƒ…å ±ã‚’å–å¾—</button>
            <div id="amazon-status" style="font-size:0.8rem; margin-top:5px;"></div>
        </div>

        <div class="card">
            <h3>ãƒãƒƒãƒˆã§æœ¬ã‚’æ¤œç´¢</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="wishSearchInput" class="text-input" placeholder="é¡Œåã‚„ä½œè€…å">
                <button class="btn btn-primary" onclick="searchWishCandidates()">æ¤œç´¢</button>
            </div>
            <div id="wishCandidates" style="max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:8px; display:none; margin-top:10px;"></div>
        </div>

        <div class="card">
            <h3>è²·ã„ãŸã„æœ¬ãƒªã‚¹ãƒˆ</h3>
            <div id="wishListUI"></div>
        </div>
    </section>

    <!-- 3. ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ -->
    <section id="page-scan" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <div id="reader"></div>
            <div id="scan-status" style="margin-top:10px; font-weight:bold;">ã‚«ãƒ¡ãƒ©æº–å‚™ä¸­...</div>
        </div>
    </section>

    <!-- 4. è”µæ›¸ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
    <section id="page-history" class="page">
        <button class="btn btn-secondary" onclick="navTo('page-top')">â† æˆ»ã‚‹</button>
        <div class="card">
            <input type="text" id="searchInput" class="text-input" placeholder="è”µæ›¸å†…ã‚’æ¤œç´¢..." oninput="handleSearch()">
            <div id="historyListUI" style="margin-top:10px;"></div>
        </div>
    </section>
</div>

<script>
    let books = JSON.parse(localStorage.getItem('myBooks') || '[]');
    let wishlist = JSON.parse(localStorage.getItem('myWishlist') || '[]');
    let html5QrCode = null;

    // --- ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ ---
    async function navTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if (html5QrCode) {
            try { await html5QrCode.stop(); html5QrCode = null; } catch(e) {}
        }
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'page-scan') startScanner();
        updateUI();
    }

    // --- UIæ›´æ–° ---
    function updateUI() {
        document.getElementById('current-count').innerText = books.length;
        document.getElementById('wish-count').innerText = wishlist.length;
        
        // ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆæç”»
        const wishUI = document.getElementById('wishListUI');
        wishUI.innerHTML = wishlist.length === 0 ? "ãƒªã‚¹ãƒˆã¯ç©ºã§ã™" : wishlist.map((b, i) => `
            <div class="list-item">
                <div class="item-info"><span class="item-title">${b.title}</span><small>${b.author}</small></div>
                <button class="btn btn-primary btn-small" onclick="moveToLibrary(${i})">è³¼å…¥</button>
            </div>
        `).reverse().join('');

        // è”µæ›¸ä¸€è¦§æç”» (æ¤œç´¢ä¸­ä»¥å¤–)
        if (document.getElementById('page-history').classList.contains('active')) {
            handleSearch(); 
        }
    }

    // --- Amazon URL è§£æ ---
    async function addFromAmazonUrl() {
        const urlInput = document.getElementById('amazonUrlInput');
        const statusEl = document.getElementById('amazon-status');
        const url = urlInput.value.trim();
        if (!url) return;

        statusEl.innerText = "URLè§£æä¸­...";
        statusEl.style.color = "inherit";

        // æ”¹è‰¯ã•ã‚ŒãŸASIN/ISBNæŠ½å‡ºæ­£è¦è¡¨ç¾
        const regex = /\/(?:dp|gp\/product|ASIN)\/([A-Z0-9]{10,13})/i;
        const match = url.match(regex);

        if (match && match[1]) {
            const code = match[1];
            try {
                // openBDã§æ¤œç´¢
                const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${code}`);
                const data = await res.json();
                if (data && data[0]) {
                    const info = data[0].summary;
                    addToWishlist(info.title, info.author, info.publisher, info.isbn);
                    statusEl.innerText = "âœ… è¿½åŠ ã—ã¾ã—ãŸ: " + info.title;
                    urlInput.value = "";
                } else {
                    // Google Books APIã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œç´¢
                    const gRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${code}`);
                    const gData = await gRes.json();
                    if (gData.items) {
                        const info = gData.items[0].volumeInfo;
                        addToWishlist(info.title, info.authors?.join(','), info.publisher, code);
                        statusEl.innerText = "âœ… è¿½åŠ ã—ã¾ã—ãŸ: " + info.title;
                        urlInput.value = "";
                    } else {
                        statusEl.innerText = "âŒ æ›¸ç±æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
                    }
                }
            } catch (e) {
                statusEl.innerText = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            }
        } else {
            statusEl.innerText = "âŒ URLã‹ã‚‰å•†å“ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
            statusEl.style.color = "red";
        }
    }

    // --- ãƒãƒƒãƒˆæ¤œç´¢ ---
    async function searchWishCandidates() {
        const query = document.getElementById('wishSearchInput').value.trim();
        const target = document.getElementById('wishCandidates');
        if (!query) return;

        target.style.display = "block";
        target.innerHTML = "æ¤œç´¢ä¸­...";

        try {
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
            const data = await res.json();
            
            if (!data.items || data.items.length === 0) {
                target.innerHTML = "<div style='padding:10px;'>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>";
                return;
            }

            target.innerHTML = data.items.map(item => {
                const info = item.volumeInfo;
                const book = {
                    title: info.title || "ä¸æ˜ãªã‚¿ã‚¤ãƒˆãƒ«",
                    author: info.authors ? info.authors.join(', ') : "è‘—è€…ä¸æ˜",
                    publisher: info.publisher || "",
                    isbn: info.industryIdentifiers ? info.industryIdentifiers[0].identifier : ""
                };
                return `
                    <div class="candidate-item">
                        <div style="font-size:0.8rem;"><strong>${book.title}</strong><br>${book.author}</div>
                        <button class="btn btn-wish btn-small" onclick='addToWishlist("${book.title}","${book.author}","${book.publisher}","${book.isbn}")'>è¿½åŠ </button>
                    </div>
                `;
            }).join('');
        } catch (e) {
            target.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        }
    }

    // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
    function addToWishlist(title, author, publisher, isbn) {
        wishlist.push({ title, author, publisher, isbn, date: "æœªè³¼å…¥", rating: 0, impression: "" });
        saveData();
        alert("ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼");
    }

    function moveToLibrary(i) {
        const b = wishlist[i];
        b.date = new Date().toLocaleDateString('ja-JP');
        books.push(b);
        wishlist.splice(i, 1);
        saveData();
    }

    function saveData() {
        localStorage.setItem('myBooks', JSON.stringify(books));
        localStorage.setItem('myWishlist', JSON.stringify(wishlist));
        updateUI();
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const listUI = document.getElementById('historyListUI');
        const filtered = books.filter(b => (b.title + b.author).toLowerCase().includes(term));
        listUI.innerHTML = filtered.map(b => `
            <div class="list-item">
                <div class="item-info"><strong>${b.title}</strong><br><small>${b.author}</small></div>
            </div>
        `).reverse().join('');
    }

    // --- ã‚«ãƒ¡ãƒ©èµ·å‹• ---
    function startScanner() {
        const statusEl = document.getElementById('scan-status');
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (isbn) => {
            if (isbn.startsWith("978")) {
                fetchBookInfo(isbn);
            }
        }).catch(err => { statusEl.innerText = "ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + err; });
    }

    async function fetchBookInfo(isbn) {
        document.getElementById('scan-status').innerText = "æƒ…å ±å–å¾—ä¸­...";
        try {
            const res = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
            const data = await res.json();
            if (data && data[0]) {
                const info = data[0].summary;
                if (!books.some(b => b.isbn === info.isbn)) {
                    books.push({ title: info.title, author: info.author, publisher: info.publisher, date: new Date().toLocaleDateString('ja-JP'), isbn: info.isbn, rating: 0, impression: "" });
                    saveData();
                    document.getElementById('scan-status').innerText = "âœ… ç™»éŒ²: " + info.title;
                } else { document.getElementById('scan-status').innerText = "âš ï¸ ç™»éŒ²æ¸ˆã¿ã§ã™"; }
            }
        } catch(e) {}
    }

    // åˆå›èµ·å‹•
    updateUI();
</script>
</body>
</html>
